package jp.moyashi.phoneos.core.apps.launcher.ui;

import jp.moyashi.phoneos.core.Kernel;
import jp.moyashi.phoneos.core.ui.Screen;
import jp.moyashi.phoneos.core.app.IApplication;
import jp.moyashi.phoneos.core.apps.launcher.model.HomePage;
import jp.moyashi.phoneos.core.apps.launcher.model.Shortcut;
import jp.moyashi.phoneos.core.input.GestureListener;
import jp.moyashi.phoneos.core.input.GestureEvent;
import jp.moyashi.phoneos.core.input.GestureType;
import processing.core.PApplet;
import processing.core.PGraphics;

import java.util.ArrayList;
import java.util.List;

/**
 * The main home screen of the MochiMobileOS launcher application.
 * This screen serves as the primary interface that users see when the OS starts.
 * It displays app shortcuts in a grid layout and provides access to the app library.
 * 
 * The home screen features:
 * - A grid of app shortcuts for quick access to frequently used applications
 * - Swipe right gesture or button click to access the app library
 * - Status information display
 * - Responsive touch interaction
 * 
 * This is the new implementation supporting multi-page editable home screens.
 * Features drag-and-drop, edit mode with delete buttons, and page management.
 * 
 * @author YourName
 * @version 3.0
 * @since 1.0
 */
public class HomeScreen implements Screen, GestureListener {
    
    /** Reference to the OS kernel for accessing system services */
    private final Kernel kernel;
    
    /** Background image for the home screen */
    private processing.core.PImage backgroundImage;
    
    /** Background color for the home screen (fallback) */
    private int backgroundColor;
    
    /** Text color for the home screen */
    private int textColor;
    
    /** Accent color for UI elements */
    private int accentColor;
    
    /** Flag to track if the screen has been initialized */
    private boolean isInitialized;
    
    /** List of home screen pages */
    private List<HomePage> homePages;
    
    /** Current page index */
    private int currentPageIndex;
    
    /** Edit mode state */
    private boolean isEditing;
    
    /** Long press detection */
    private long touchStartTime;
    private boolean longPressTriggered;
    private static final long LONG_PRESS_DURATION = 500; // 500ms
    
    /** Dragging state */
    private Shortcut draggedShortcut;
    private boolean isDragging;
    private int dragOffsetX;
    private int dragOffsetY;
    
    /** Page swiping and animation */
    private float swipeStartX;
    private boolean isSwipingPages;
    private static final float SWIPE_THRESHOLD = 50.0f;
    
    /** Page transition animation */
    private float pageTransitionOffset = 0.0f;
    private boolean isAnimating = false;
    private float animationProgress = 0.0f;
    private int targetPageIndex = 0;
    private long animationStartTime = 0;
    private float startOffset = 0.0f; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßãÊôÇ„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà
    private int animationBasePageIndex = 0; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅÆÂü∫Ê∫ñ„Éö„Éº„Ç∏ÔºàÂõ∫ÂÆöÔºâ
    private static final long ANIMATION_DURATION = 500; // 500ms for smoother animation
    
    /** Grid configuration for app shortcuts */
    private static final int GRID_COLS = 4;
    private static final int GRID_ROWS = 5;
    private static final int ICON_SIZE = 48; // Reduced from 64 to 48
    private static final int ICON_SPACING = 15; // Reduced from 20 to 15
    
    /** App library navigation area */
    private static final int NAV_AREA_HEIGHT = 100;
    
    /**
     * Constructs a new HomeScreen instance.
     * 
     * @param kernel The OS kernel instance providing access to system services
     */
    public HomeScreen(Kernel kernel) {
        this.kernel = kernel;
        this.backgroundColor = 0x1E1E1E; // Dark theme background
        this.textColor = 0xFFFFFF;       // White text
        this.accentColor = 0x4A90E2;     // Blue accent
        this.isInitialized = false;
        this.homePages = new ArrayList<>();
        this.currentPageIndex = 0;
        this.isEditing = false;
        this.longPressTriggered = false;
        this.draggedShortcut = null;
        this.isDragging = false;
        this.isSwipingPages = false;
        this.pageTransitionOffset = 0.0f;
        this.isAnimating = false;
        this.targetPageIndex = 0;
        
        System.out.println("üì± HomeScreen: Advanced launcher home screen created");
        System.out.println("    ‚Ä¢ Multi-page support ready");
        System.out.println("    ‚Ä¢ Drag & drop system initialized");
        System.out.println("    ‚Ä¢ Edit mode with animations enabled");
    }
    
    /**
     * Initializes the home screen when it becomes active.
     * Sets up the app shortcuts and prepares the UI for display.
     *
     * @deprecated Use setup(PGraphics g) instead for unified graphics architecture
     */
    @Override
    @Deprecated
    public void setup(processing.core.PApplet p) {
        PGraphics g = p.g;
        setup(g);
    }

    /**
     * Initializes the home screen when it becomes active (PGraphics version).
     * Sets up the app shortcuts and prepares the UI for display.
     *
     * @param g The PGraphics instance for drawing operations
     */
    public void setup(PGraphics g) {
        if (isInitialized) {
            System.out.println("‚ö†Ô∏è HomeScreen: setup() called again - skipping duplicate initialization");
            return;
        }
        
        isInitialized = true;
        System.out.println("üöÄ HomeScreen: Initializing multi-page launcher...");
        
        // ËÉåÊôØÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø
        loadBackgroundImage();
        
        initializeHomePages();
        
        // Count total shortcuts
        int totalShortcuts = 0;
        for (HomePage page : homePages) {
            totalShortcuts += page.getShortcutCount();
        }
        
        System.out.println("‚úÖ HomeScreen: Initialization complete!");
        System.out.println("    ‚Ä¢ Pages created: " + homePages.size());
        System.out.println("    ‚Ä¢ Total shortcuts: " + totalShortcuts);
        System.out.println("    ‚Ä¢ Grid size: " + GRID_COLS + "x" + GRID_ROWS + " per page");
        System.out.println("    ‚Ä¢ Ready for user interaction!");
        System.out.println();
        System.out.println("üéÆ HOW TO USE:");
        System.out.println("    ‚Ä¢ Tap icons to launch apps");
        System.out.println("    ‚Ä¢ Long press for edit mode");
        System.out.println("    ‚Ä¢ Drag icons to rearrange");
        System.out.println("    ‚Ä¢ Swipe left/right for pages");
        System.out.println("    ‚Ä¢ Swipe up for App Library");
        
        // Register gesture listener
        if (kernel != null && kernel.getGestureManager() != null) {
            kernel.getGestureManager().addGestureListener(this);
            System.out.println("HomeScreen: Registered gesture listener");
        }
    }
    
    /**
     * Draws the home screen interface.
     * Renders the background, app shortcuts grid, navigation hints, and system information.
     *
     * @param p The PApplet instance for drawing operations
     * @deprecated Use draw(PGraphics g) instead for unified graphics architecture
     */
    @Override
    @Deprecated
    public void draw(PApplet p) {
        PGraphics g = p.g;
        draw(g);
    }

    /**
     * Draws the home screen using PGraphics (unified architecture).
     *
     * @param g The PGraphics instance to draw to
     */
    public void draw(PGraphics g) {
        try {
            // „Éö„Éº„Ç∏„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüËÉåÊôØÂá¶ÁêÜ
            HomePage currentPage = getCurrentPage();
            if (currentPage != null && currentPage.isAppLibraryPage()) {
                // AppLibrary„Éö„Éº„Ç∏Áî®„ÅÆËÉåÊôØ
                g.background(42, 42, 42); // „ÉÄ„Éº„ÇØ„Ç∞„É¨„Éº
            } else {
                // ÈÄöÂ∏∏„Éö„Éº„Ç∏Áî®„ÅÆËÉåÊôØ
                if (backgroundImage != null) {
                    g.background(30, 30, 30); // „Éô„Éº„ÇπËÉåÊôØËâ≤
                    g.image(backgroundImage, 0, 0, 400, 600);
                } else {
                    g.background(30, 30, 30);
                }
            }

            // Update page transition animation
            updatePageAnimation();

            // Check edge auto-slide timer continuously during drag
            updateEdgeAutoSlideTimer();

            // Draw status bar
            drawStatusBar(g);

            // Draw pages with transition animation
            drawPagesWithTransition(g);

            // Draw navigation area
            drawNavigationArea(g);

            // Draw page indicator dots
            drawPageIndicators(g);

        } catch (Exception e) {
            System.err.println("‚ùå HomeScreen: Draw error (PGraphics) - " + e.getMessage());
            e.printStackTrace();
            // Fallback drawing
            g.background(255, 0, 0);
            g.fill(255);
            g.textAlign(g.CENTER, g.CENTER);

            // Êó•Êú¨Ë™û„Éï„Ç©„É≥„Éà„ÇíË®≠ÂÆö
            if (kernel != null && kernel.getJapaneseFont() != null) {
                g.textFont(kernel.getJapaneseFont());
            }

            g.textSize(16);
            g.text("HomeScreen Error: " + e.getMessage(), g.width/2, g.height/2);
        }
    }

    /**
     * Handles mouse press events on the home screen.
     * Processes app shortcut clicks and navigation gestures.
     *
     * @param mouseX The x-coordinate of the mouse press
     * @param mouseY The y-coordinate of the mouse press
     * @deprecated Use mousePressed(PGraphics g, int, int) instead for unified graphics architecture
     */
    @Override
    @Deprecated
    public void mousePressed(processing.core.PApplet p, int mouseX, int mouseY) {
        PGraphics g = p.g;
        mousePressed(g, mouseX, mouseY);
    }

    /**
     * Handles mouse press events on the home screen (PGraphics version).
     * Processes app shortcut clicks and navigation gestures.
     *
     * @param g The PGraphics instance
     * @param mouseX The x-coordinate of the mouse press
     * @param mouseY The y-coordinate of the mouse press
     */
    public void mousePressed(PGraphics g, int mouseX, int mouseY) {
        System.out.println("HomeScreen: Touch at (" + mouseX + ", " + mouseY + ")");

        touchStartTime = System.currentTimeMillis();
        longPressTriggered = false;
        swipeStartX = mouseX;
        isSwipingPages = false;

        // Check if click is in navigation area (app library), but not in control center area
        // Control center area starts at 90% of screen height (540px), nav area ends at 500px
        if (mouseY > (600 - NAV_AREA_HEIGHT) && mouseY < 540) {
            openAppLibrary();
            return;
        }

        // Check if click is on a shortcut (Â∫ßÊ®ôÂ§âÊèõ„ÇíËÄÉÊÖÆ)
        Shortcut clickedShortcut = getShortcutAtPositionWithTransform(mouseX, mouseY);
        if (clickedShortcut != null) {
            if (isEditing) {
                // In edit mode, check if clicking delete button
                if (isClickingDeleteButtonWithTransform(mouseX, mouseY, clickedShortcut)) {
                    removeShortcut(clickedShortcut);
                    return;
                }
                // Start potential dragging
                startDragging(clickedShortcut, mouseX, mouseY);
            } else {
                // Normal mode - launch app with animation
                int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
                int startX = (400 - gridWidth) / 2;
                int startY = 80;
                float iconX = startX + clickedShortcut.getGridX() * (ICON_SIZE + ICON_SPACING) + ICON_SIZE / 2;
                float iconY = startY + clickedShortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20) + ICON_SIZE / 2;
                launchApplicationWithAnimation(clickedShortcut.getApplication(), iconX, iconY, ICON_SIZE);
            }
        } else {
            // Empty area - could be page swipe or long press for edit mode
            if (isEditing) {
                // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Å´Á©∫„ÅÆ„Çπ„Éö„Éº„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØÁ∑®ÈõÜ„É¢„Éº„ÉâÁµÇ‰∫Ü„Çí‰∫àÁ¥Ñ
                // ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØGestureManager„ÅÆTAP„Ç§„Éô„É≥„Éà„ÅßÂÆüË°å„Åï„Çå„Çã
                System.out.println("HomeScreen: Empty space clicked in edit mode - will exit on TAP");
            } else {
                // Start monitoring for long press to enter edit mode
            }
        }
    }
    
    /**
     * Checks if the mouse click is on a shortcut's delete button.
     * 
     * @param mouseX The mouse x coordinate
     * @param mouseY The mouse y coordinate
     * @param shortcut The shortcut to check
     * @return true if clicking the delete button
     */
    private boolean isClickingDeleteButton(int mouseX, int mouseY, Shortcut shortcut) {
        if (!isEditing) return false;
        
        int startY = 80;
        int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
        int startX = (400 - gridWidth) / 2;
        
        int iconX = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
        int iconY = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20);
        
        int deleteX = iconX + ICON_SIZE - 8;
        int deleteY = iconY + 8;
        
        return Math.sqrt((mouseX - deleteX) * (mouseX - deleteX) + (mouseY - deleteY) * (mouseY - deleteY)) <= 8;
    }
    
    /**
     * Â∫ßÊ®ôÂ§âÊèõ„ÇíËÄÉÊÖÆ„Åó„ÅüÂâäÈô§„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÂà§ÂÆö„ÄÇ
     * 
     * @param mouseX „Éû„Ç¶„ÇπXÂ∫ßÊ®ôÔºàÁµ∂ÂØæÂ∫ßÊ®ôÔºâ
     * @param mouseY „Éû„Ç¶„ÇπYÂ∫ßÊ®ôÔºàÁµ∂ÂØæÂ∫ßÊ®ôÔºâ
     * @param shortcut ÂØæË±°„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
     * @return ÂâäÈô§„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean isClickingDeleteButtonWithTransform(int mouseX, int mouseY, Shortcut shortcut) {
        if (!isEditing) return false;
        
        // ÁèæÂú®„ÅÆÂ∫ßÊ®ôÂ§âÊèõ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆó
        int basePageForOffset = isAnimating ? animationBasePageIndex : currentPageIndex;
        float totalOffset = -basePageForOffset * 400 + pageTransitionOffset;
        
        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Åå„Å©„ÅÆ„Éö„Éº„Ç∏„Å´„ÅÇ„Çã„Åã„ÇíÁâπÂÆö
        int shortcutPageIndex = -1;
        for (int i = 0; i < homePages.size(); i++) {
            HomePage page = homePages.get(i);
            if (page.getShortcuts().contains(shortcut)) {
                shortcutPageIndex = i;
                break;
            }
        }
        
        if (shortcutPageIndex == -1) return false;
        
        // „Éö„Éº„Ç∏ÂÜÖ„Åß„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂ∫ßÊ®ô„ÇíË®àÁÆó
        int startY = 80;
        int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
        int startX = (400 - gridWidth) / 2;
        
        int iconX = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
        int iconY = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20);
        
        // ÁîªÈù¢‰∏ä„Åß„ÅÆÂâäÈô§„Éú„Çø„É≥‰ΩçÁΩÆ„ÇíË®àÁÆóÔºàÂ∫ßÊ®ôÂ§âÊèõ„ÇíËÄÉÊÖÆÔºâ
        float screenDeleteX = totalOffset + shortcutPageIndex * 400 + iconX + ICON_SIZE - 8;
        float screenDeleteY = iconY + 8;
        
        return Math.sqrt((mouseX - screenDeleteX) * (mouseX - screenDeleteX) + (mouseY - screenDeleteY) * (mouseY - screenDeleteY)) <= 8;
    }
    
    /**
     * Handles mouse drag events for shortcut dragging and page swiping.
     * Note: „Åì„ÅÆ„É°„ÇΩ„ÉÉ„Éâ„ÅØÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ
     * ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØ GestureManager „Ç∑„Çπ„ÉÜ„É†„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ
     *
     * @deprecated Use mouseDragged(PGraphics g, int, int) instead for unified graphics architecture
     */
    @Deprecated
    public void mouseDragged(processing.core.PApplet p, int mouseX, int mouseY) {
        PGraphics g = p.g;
        mouseDragged(g, mouseX, mouseY);
    }

    /**
     * Handles mouse drag events for shortcut dragging and page swiping (PGraphics version).
     * Note: „Åì„ÅÆ„É°„ÇΩ„ÉÉ„Éâ„ÅØÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ
     * ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØ GestureManager „Ç∑„Çπ„ÉÜ„É†„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ
     *
     * @param g The PGraphics instance
     * @param mouseX The x-coordinate of the mouse drag
     * @param mouseY The y-coordinate of the mouse drag
     */
    public void mouseDragged(PGraphics g, int mouseX, int mouseY) {
        // GestureManager„Ç∑„Çπ„ÉÜ„É†„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        // ÂÆüÈöõ„ÅÆ„Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ„ÅØ onGesture -> handleDragMove „ÅßÂÆüË°å„Åï„Çå„Çã
        System.out.println("HomeScreen: mouseDragged called - delegating to GestureManager");
    }

    /**
     * Handles mouse release events.
     * Note: „Åì„ÅÆ„É°„ÇΩ„ÉÉ„Éâ„ÅØÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ
     * ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØ GestureManager „Ç∑„Çπ„ÉÜ„É†„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ
     *
     * @deprecated Use mouseReleased(PGraphics g, int, int) instead for unified graphics architecture
     */
    @Deprecated
    public void mouseReleased(processing.core.PApplet p, int mouseX, int mouseY) {
        PGraphics g = p.g;
        mouseReleased(g, mouseX, mouseY);
    }

    /**
     * Handles mouse release events (PGraphics version).
     * Note: „Åì„ÅÆ„É°„ÇΩ„ÉÉ„Éâ„ÅØÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅ„Å´ÊÆã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ
     * ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØ GestureManager „Ç∑„Çπ„ÉÜ„É†„ÅßË°å„Çè„Çå„Åæ„Åô„ÄÇ
     *
     * @param g The PGraphics instance
     * @param mouseX The x-coordinate of the mouse release
     * @param mouseY The y-coordinate of the mouse release
     */
    public void mouseReleased(PGraphics g, int mouseX, int mouseY) {
        // GestureManager„Ç∑„Çπ„ÉÜ„É†„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÅØÂü∫Êú¨ÁöÑ„Å´‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        // ÂÆüÈöõ„ÅÆÂá¶ÁêÜ„ÅØ onGesture -> handleDragEnd, handleLongPress „ÅßÂÆüË°å„Åï„Çå„Çã
        System.out.println("HomeScreen: mouseReleased called - delegating to GestureManager");

        // Âøµ„ÅÆ„Åü„ÇÅÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÂÆâÂÖ®Êé™ÁΩÆÔºâ
        resetDragState();
        isSwipingPages = false;
    }
    
    /**
     * Starts dragging a shortcut.
     * 
     * @param shortcut The shortcut to drag
     * @param mouseX Current mouse X
     * @param mouseY Current mouse Y
     */
    private void startDragging(Shortcut shortcut, int mouseX, int mouseY) {
        draggedShortcut = shortcut;
        isDragging = true;
        shortcut.setDragging(true);
        
        // Â∫ßÊ®ôÂ§âÊèõ„ÇíËÄÉÊÖÆ„Åó„Å¶„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆÁîªÈù¢‰∏ä‰ΩçÁΩÆ„ÇíË®àÁÆó
        int basePageForOffset = isAnimating ? animationBasePageIndex : currentPageIndex;
        float totalOffset = -basePageForOffset * 400 + pageTransitionOffset;
        
        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Åå„Å©„ÅÆ„Éö„Éº„Ç∏„Å´„ÅÇ„Çã„Åã„ÇíÁâπÂÆö
        int shortcutPageIndex = -1;
        for (int i = 0; i < homePages.size(); i++) {
            HomePage page = homePages.get(i);
            if (page.getShortcuts().contains(shortcut)) {
                shortcutPageIndex = i;
                break;
            }
        }
        
        if (shortcutPageIndex != -1) {
            // „Éö„Éº„Ç∏ÂÜÖ„Åß„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂ∫ßÊ®ô„ÇíË®àÁÆó
            int startY = 80;
            int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
            int startX = (400 - gridWidth) / 2;
            
            int localShortcutX = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
            int shortcutY = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20);
            
            // ÁîªÈù¢‰∏ä„Åß„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà‰ΩçÁΩÆ„ÇíË®àÁÆóÔºàÂ∫ßÊ®ôÂ§âÊèõ„ÇíËÄÉÊÖÆÔºâ
            int screenShortcutX = (int) (totalOffset + shortcutPageIndex * 400 + localShortcutX);
            
            dragOffsetX = mouseX - screenShortcutX;
            dragOffsetY = mouseY - shortcutY;
        } else {
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆË®àÁÆó
            int startY = 80;
            int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
            int startX = (400 - gridWidth) / 2;
            
            int shortcutX = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
            int shortcutY = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20);
            
            dragOffsetX = mouseX - shortcutX;
            dragOffsetY = mouseY - shortcutY;
        }
        
        System.out.println("HomeScreen: Started dragging " + shortcut.getDisplayName());
    }
    
    /**
     * Handles dropping a dragged shortcut.
     * 
     * @param mouseX Drop position X
     * @param mouseY Drop position Y
     */
    private void handleShortcutDrop(int mouseX, int mouseY) {
        if (draggedShortcut == null) return;

        System.out.println("HomeScreen: [DROP] Handling shortcut drop at (" + mouseX + ", " + mouseY + ") on page " + currentPageIndex);

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅÆÂ†¥Âêà„ÅØ„Éâ„É≠„ÉÉ„Éó„ÇíÈÅÖÂª∂ÂÆüË°å
        if (isAnimating) {
            System.out.println("HomeScreen: [DROP] Animation in progress, scheduling drop for later");
            scheduleDelayedDrop(mouseX, mouseY);
            return;
        }

        // Âç≥Â∫ß„Å´„Éâ„É≠„ÉÉ„Éó„ÇíÂÆüË°å
        executeDrop(mouseX, mouseY, draggedShortcut);
    }

    /**
     * Handles moving a shortcut to the next page when dragged to the right edge.
     */
    private void handleShortcutMoveToNextPage() {
        if (draggedShortcut == null) return;

        HomePage currentPage = getCurrentPage();
        if (currentPage != null) {
            // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Åã„Çâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÂâäÈô§
            currentPage.removeShortcut(draggedShortcut);

            // Ê¨°„ÅÆ„Éö„Éº„Ç∏„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
            int nextPageIndex = currentPageIndex + 1;
            if (nextPageIndex >= homePages.size()) {
                // Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê
                addNewPage();
            }

            // Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï
            HomePage nextPage = homePages.get(nextPageIndex);
            if (nextPage != null && !nextPage.isAppLibraryPage()) {
                // Ê¨°„ÅÆ„Éö„Éº„Ç∏„ÅÆÊúÄÂàù„ÅÆÁ©∫„Åç„Çπ„É≠„ÉÉ„Éà„Å´ËøΩÂä†
                int[] emptySlot = findFirstEmptySlot(nextPage);
                if (emptySlot != null) {
                    draggedShortcut.setGridPosition(emptySlot[0], emptySlot[1]);
                    nextPage.addShortcut(draggedShortcut);

                    // Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å´Ëá™ÂãïÁöÑ„Å´„Çπ„É©„Ç§„Éâ
                    startPageTransition(nextPageIndex);

                    System.out.println("HomeScreen: „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï„Åó„Åæ„Åó„Åü");

                    // „É¨„Ç§„Ç¢„Ç¶„Éà„ÇíËá™Âãï‰øùÂ≠ò
                    saveCurrentLayout();
                } else {
                    // Ê¨°„ÅÆ„Éö„Éº„Ç∏„Åå„Éï„É´„ÅÆÂ†¥Âêà„ÄÅ„Åï„Çâ„Å´Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê
                    addNewPage();
                    HomePage newPage = homePages.get(homePages.size() - 1);
                    draggedShortcut.setGridPosition(0, 0);
                    newPage.addShortcut(draggedShortcut);
                    startPageTransition(homePages.size() - 1);

                    System.out.println("HomeScreen: Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÁßªÂãï„Åó„Åæ„Åó„Åü");
                    saveCurrentLayout();
                }
            }
        }

        // Reset drag state
        resetDragState();
    }

    /**
     * Finds the first empty slot in a page.
     * @param page The page to search
     * @return [x, y] coordinates of the first empty slot, or null if page is full
     */
    private int[] findFirstEmptySlot(HomePage page) {
        for (int y = 0; y < GRID_ROWS; y++) {
            for (int x = 0; x < GRID_COLS; x++) {
                if (page.getShortcutAt(x, y) == null) {
                    return new int[]{x, y};
                }
            }
        }
        return null; // Page is full
    }

    /**
     * Handles page swipe gesture.
     * 
     * @param mouseX Final mouse X position
     */
    private void handlePageSwipe(int mouseX) {
        float swipeDistance = mouseX - swipeStartX;
        
        if (swipeDistance > SWIPE_THRESHOLD) {
            // Swipe right - go to previous page
            if (currentPageIndex > 0) {
                currentPageIndex--;
                System.out.println("HomeScreen: Swiped to page " + currentPageIndex);
            }
        } else if (swipeDistance < -SWIPE_THRESHOLD) {
            // Swipe left - go to next page
            if (currentPageIndex < homePages.size() - 1) {
                currentPageIndex++;
                System.out.println("HomeScreen: Swiped to page " + currentPageIndex);
            }
        }
    }
    
    /**
     * Converts screen coordinates to grid position.
     * 
     * @param screenX Screen X coordinate
     * @param screenY Screen Y coordinate
     * @return Grid position [x, y] or null if invalid
     */
    private int[] screenToGridPosition(int screenX, int screenY) {
        int startY = 80;
        int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
        int startX = (400 - gridWidth) / 2;
        
        // Check if within grid bounds
        if (screenX < startX || screenY < startY) {
            return null;
        }
        
        int gridX = (screenX - startX) / (ICON_SIZE + ICON_SPACING);
        int gridY = (screenY - startY) / (ICON_SIZE + ICON_SPACING + 20);
        
        if (gridX >= 0 && gridX < GRID_COLS && gridY >= 0 && gridY < GRID_ROWS) {
            return new int[]{gridX, gridY};
        }
        
        return null;
    }
    
    /**
     * Resets drag-related state.
     */
    private void resetDragState() {
        if (draggedShortcut != null) {
            draggedShortcut.setDragging(false);
            draggedShortcut = null;
        }
        isDragging = false;
    }
    
    /**
     * Removes a shortcut from the current page.
     * 
     * @param shortcut The shortcut to remove
     */
    private void removeShortcut(Shortcut shortcut) {
        HomePage currentPage = getCurrentPage();
        if (currentPage != null) {
            currentPage.removeShortcut(shortcut);
            System.out.println("HomeScreen: „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÂâäÈô§: " + shortcut.getDisplayName());
            
            // „É¨„Ç§„Ç¢„Ç¶„Éà„ÇíËá™Âãï‰øùÂ≠ò
            saveCurrentLayout();
        }
    }
    
    /**
     * ÁèæÂú®„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíLayoutManager„Å´‰øùÂ≠ò„Åô„Çã„ÄÇ
     */
    private void saveCurrentLayout() {
        if (kernel != null && kernel.getLayoutManager() != null && homePages != null) {
            boolean success = kernel.getLayoutManager().saveLayout(homePages);
            if (success) {
                System.out.println("HomeScreen: „É¨„Ç§„Ç¢„Ç¶„Éà‰øùÂ≠òÊàêÂäü");
            } else {
                System.err.println("HomeScreen: „É¨„Ç§„Ç¢„Ç¶„Éà‰øùÂ≠òÂ§±Êïó");
            }
        }
    }
    
    /**
     * Cleans up resources when the screen is deactivated.
     *
     * @deprecated Use cleanup(PGraphics g) instead for unified graphics architecture
     */
    @Override
    @Deprecated
    public void cleanup(processing.core.PApplet p) {
        PGraphics g = p.g;
        cleanup(g);
    }

    /**
     * Cleans up the home screen resources (PGraphics version).
     *
     * @param g The PGraphics instance
     */
    public void cleanup(PGraphics g) {
        // Unregister gesture listener
        if (kernel != null && kernel.getGestureManager() != null) {
            kernel.getGestureManager().removeGestureListener(this);
            System.out.println("HomeScreen: Unregistered gesture listener");
        }

        isInitialized = false;
        resetDragState();
        isEditing = false;
        System.out.println("HomeScreen: Launcher home screen cleaned up");
    }
    
    /**
     * ËÉåÊôØÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÄ„ÄÇ
     */
    private void loadBackgroundImage() {
        try {
            // TODO: PGraphicsÁµ±‰∏Ä„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„Å´ÂØæÂøú„Åó„ÅüÁîªÂÉèË™≠„ÅøËæº„ÅøÊ©üËÉΩ„ÇíÂÆüË£Ö
            // ÁèæÂú®„ÅØbackgroundImage„Çínull„ÅÆ„Åæ„Åæ„Å´„Åó„Å¶„ÄÅËâ≤ËÉåÊôØ„Çí‰ΩøÁî®
            System.out.println("HomeScreen: Background image loading disabled in PGraphics architecture - using color background");
            backgroundImage = null;
        } catch (Exception e) {
            System.err.println("HomeScreen: Error loading background image: " + e.getMessage());
            backgroundImage = null;
        }
    }
    
    /**
     * Gets the title of this screen.
     * 
     * @return The screen title
     */
    @Override
    public String getScreenTitle() {
        return "Home Screen";
    }
    
    /**
     * „Éõ„Éº„É†„Éö„Éº„Ç∏„ÅÆ„É™„Çπ„Éà„ÇíÂèñÂæó„Åô„Çã„ÄÇ
     * AppLibraryScreen„Åã„Çâ„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åü„ÇÅ„Å´‰ΩøÁî®„Åï„Çå„Çã„ÄÇ
     * 
     * @return „Éõ„Éº„É†„Éö„Éº„Ç∏„ÅÆ„É™„Çπ„Éà
     */
    public List<HomePage> getHomePages() {
        return homePages;
    }
    
    /**
     * ÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏Ôºà„É°„Ç§„É≥„Éõ„Éº„É†„Éö„Éº„Ç∏Ôºâ„Å´ÁßªÂãï„Åô„Çã„ÄÇ
     * „Çπ„Éö„Éº„Çπ„Ç≠„Éº„Å´„Çà„Çã„Éõ„Éº„É†„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áî®„ÄÇ
     */
    public void navigateToFirstPage() {
        System.out.println("HomeScreen: Navigating to first page");
        
        if (!homePages.isEmpty() && currentPageIndex != 0 && !isAnimating) {
            startPageTransition(0);
        } else if (currentPageIndex == 0) {
            System.out.println("HomeScreen: Already on first page");
        }
    }
    
    /**
     * „Éõ„Éº„É†„Éö„Éº„Ç∏„ÇíÂàùÊúüÂåñ„Åó„ÄÅ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíË™≠„ÅøËæº„ÇÄ„Åã„Ç¢„Éó„É™„ÇíÈÖçÁΩÆ„Åô„Çã„ÄÇ
     * „Åæ„Åö‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆË™≠„ÅøËæº„Åø„ÇíË©¶Ë°å„Åó„ÄÅÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰ΩúÊàê„Åô„Çã„ÄÇ
     */
    private void initializeHomePages() {
        try {
            homePages.clear();
            
            // ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíË™≠„ÅøËæº„ÇÄË©¶Ë°å
            boolean layoutLoaded = false;
            if (kernel != null && kernel.getLayoutManager() != null) {
                System.out.println("HomeScreen: ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...");
                List<HomePage> savedLayout = kernel.getLayoutManager().loadLayout();
                
                if (savedLayout != null && !savedLayout.isEmpty()) {
                    homePages.addAll(savedLayout);
                    layoutLoaded = true;
                    System.out.println("HomeScreen: ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü (" + homePages.size() + "„Éö„Éº„Ç∏)");
                } else {
                    System.out.println("HomeScreen: ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÅ„Éá„Éï„Ç©„É´„Éà„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰ΩúÊàê");
                }
            }

            
            // ‰øùÂ≠ò„Åï„Çå„Åü„É¨„Ç§„Ç¢„Ç¶„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰ΩúÊàê
            if (!layoutLoaded) {
                createDefaultLayout();
            }
            
            // AppLibrary„Éö„Éº„Ç∏„ÅÆÈáçË§á„ÇíÈò≤„ÅêÔºàÂé≥ÂØÜ„Å™„ÉÅ„Çß„ÉÉ„ÇØÔºâ
            long appLibraryCount = homePages.stream()
                .filter(page -> page.getPageType() == HomePage.PageType.APP_LIBRARY)
                .count();
                
            System.out.println("HomeScreen: ÁèæÂú®„ÅÆAppLibrary„Éö„Éº„Ç∏Êï∞: " + appLibraryCount);
            
            if (appLibraryCount == 0) {
                createAppLibraryPage();
                System.out.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏„ÇíÊñ∞Ë¶èËøΩÂä†„Åó„Åæ„Åó„Åü");
            } else if (appLibraryCount > 1) {
                // ÈáçË§á„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰øÆÊ≠£
                System.out.println("HomeScreen: ‚ö†Ô∏è AppLibrary„Éö„Éº„Ç∏„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„Åô(" + appLibraryCount + "ÂÄã) - ‰øÆÊ≠£‰∏≠...");
                // ÊúÄÂàù„ÅÆ„ÇÇ„ÅÆ‰ª•Â§ñ„ÇíÂâäÈô§
                List<HomePage> toRemove = new ArrayList<>();
                boolean foundFirst = false;
                for (HomePage page : homePages) {
                    if (page.getPageType() == HomePage.PageType.APP_LIBRARY) {
                        if (foundFirst) {
                            toRemove.add(page);
                        } else {
                            foundFirst = true;
                        }
                    }
                }
                homePages.removeAll(toRemove);
                System.out.println("HomeScreen: ‚úÖ " + toRemove.size() + "ÂÄã„ÅÆÈáçË§áAppLibrary„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");
            } else {
                System.out.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏„ÅØÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô");
            }
            
            System.out.println("HomeScreen: " + homePages.size() + "„Éö„Éº„Ç∏„Åß„Éõ„Éº„É†ÁîªÈù¢„ÇíÂàùÊúüÂåñÂÆå‰∫Ü");
            
        } catch (Exception e) {
            System.err.println("HomeScreen: initializeHomePages „Åß„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Ç®„É©„Éº: " + e.getMessage());
            e.printStackTrace();
            // Á∑äÊÄ•ÊôÇ„ÅØÂ∞ë„Å™„Åè„Å®„ÇÇ1„Å§„ÅÆÁ©∫„Éö„Éº„Ç∏„ÇíÁ¢∫‰øù
            if (homePages.isEmpty()) {
                homePages.add(new HomePage("Emergency"));
            }
        }
    }
    
    /**
     * „Éá„Éï„Ç©„É´„Éà„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰ΩúÊàê„Åó„ÄÅÂà©Áî®ÂèØËÉΩ„Å™„Ç¢„Éó„É™„ÇíÈÖçÁΩÆ„Åô„Çã„ÄÇ
     */
    private void createDefaultLayout() {
        // ÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„Çí‰ΩúÊàê
        HomePage firstPage = new HomePage("Home");
        homePages.add(firstPage);
        
        if (kernel != null && kernel.getAppLoader() != null) {
            try {
                List<IApplication> loadedApps = kernel.getAppLoader().getLoadedApps();
                if (loadedApps != null) {
                    // „É©„É≥„ÉÅ„É£„Éº‰ª•Â§ñ„ÅÆ„É≠„Éº„ÉâÊ∏à„Åø„Ç¢„Éó„É™„ÇíËøΩÂä†
                    List<IApplication> availableApps = new ArrayList<>();
                    for (IApplication app : loadedApps) {
                        if (app != null && !"jp.moyashi.phoneos.core.apps.launcher".equals(app.getApplicationId())) {
                            availableApps.add(app);
                        }
                    }
                    
                    HomePage currentPage = firstPage;
                    for (IApplication app : availableApps) {
                        try {
                            if (currentPage.isFull()) {
                                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅåÊ∫ÄÂì°„ÅÆÂ†¥Âêà„ÅØÊñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„Çí‰ΩúÊàê
                                currentPage = new HomePage();
                                homePages.add(currentPage);
                            }
                            currentPage.addShortcut(app);
                        } catch (Exception e) {
                            System.err.println("HomeScreen: „Éö„Éº„Ç∏„Å∏„ÅÆ„Ç¢„Éó„É™ËøΩÂä†„Ç®„É©„Éº: " + e.getMessage());
                        }
                    }
                }
            } catch (Exception e) {
                System.err.println("HomeScreen: AppLoader„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº: " + e.getMessage());
            }
        } else {
            System.out.println("HomeScreen: Kernel„Åæ„Åü„ÅØAppLoader„Åånull - Á©∫„ÅÆ„Éö„Éº„Ç∏„Çí‰ΩúÊàê");
        }
        
        // „Éá„Éï„Ç©„É´„Éà„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰øùÂ≠ò
        if (kernel != null && kernel.getLayoutManager() != null) {
            kernel.getLayoutManager().saveLayout(homePages);
            System.out.println("HomeScreen: „Éá„Éï„Ç©„É´„Éà„É¨„Ç§„Ç¢„Ç¶„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
        }
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Çí‰ΩúÊàê„Åó„ÄÅÂÖ®„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíË®≠ÂÆö„Åô„Çã„ÄÇ
     */
    private void createAppLibraryPage() {
        System.out.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏„Çí‰ΩúÊàê‰∏≠...");
        
        // AppLibrary„Éö„Éº„Ç∏„Çí‰ΩúÊàê
        HomePage appLibraryPage = new HomePage(HomePage.PageType.APP_LIBRARY, "App Library");
        
        // ÂÖ®„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂèñÂæó„Åó„Å¶AppLibrary„Éö„Éº„Ç∏„Å´Ë®≠ÂÆö
        if (kernel != null && kernel.getAppLoader() != null) {
            try {
                List<IApplication> allApps = kernel.getAppLoader().getLoadedApps();
                if (allApps != null) {
                    // „É©„É≥„ÉÅ„É£„Éº‰ª•Â§ñ„ÅÆ„Ç¢„Éó„É™„ÇíÂèñÂæó
                    List<IApplication> availableApps = new ArrayList<>();
                    for (IApplication app : allApps) {
                        if (app != null && !"jp.moyashi.phoneos.core.apps.launcher".equals(app.getApplicationId())) {
                            availableApps.add(app);
                        }
                    }
                    appLibraryPage.setAllApplications(availableApps);
                    System.out.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏„Å´ " + availableApps.size() + " ÂÄã„ÅÆ„Ç¢„Éó„É™„ÇíË®≠ÂÆö");
                }
            } catch (Exception e) {
                System.err.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏‰ΩúÊàê„Ç®„É©„Éº: " + e.getMessage());
            }
        }
        
        // „Éö„Éº„Ç∏„É™„Çπ„Éà„Å´ËøΩÂä†
        homePages.add(appLibraryPage);
        System.out.println("HomeScreen: AppLibrary„Éö„Éº„Ç∏„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");
        System.out.println("HomeScreen: Á∑è„Éö„Éº„Ç∏Êï∞: " + homePages.size() + ", AppLibrary„Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ: " + (homePages.size() - 1));
    }
    
    /**
     * Draws the status bar at the top of the screen.
     * 
     * @param p The PApplet instance for drawing
     */
    private void drawStatusBar(PGraphics g) {
        try {
            g.fill(textColor, 180); // Semi-transparent text
            g.textAlign(g.LEFT, g.TOP);
            g.textSize(12);
            
            // Current time
            if (kernel != null && kernel.getSystemClock() != null) {
                try {
                    g.text(kernel.getSystemClock().getFormattedTime(), 15, 15);
                } catch (Exception e) {
                    g.text("--:--", 15, 15);
                }
            } else {
                g.text("No Clock", 15, 15);
            }
            
            // System status and current page info
            g.textAlign(g.RIGHT, g.TOP);
            g.text("MochiOS", 385, 15);
            
            // Current page name
            if (!homePages.isEmpty() && currentPageIndex < homePages.size()) {
                HomePage currentPage = homePages.get(currentPageIndex);
                String pageName = currentPage.isAppLibraryPage() ? "App Library" : 
                                 currentPage.getPageName() != null ? currentPage.getPageName() : 
                                 "Page " + (currentPageIndex + 1);
                                 
                g.fill(255, 255, 255, 150);
                g.textAlign(g.CENTER, g.TOP);
                g.textSize(11);
                g.text(pageName, 200, 15);
            }
            
            // Status indicator
            if (isInitialized) {
                g.fill(76, 175, 80); // Green if ready (0x4CAF50 -> RGB)
            } else {
                g.fill(255, 152, 0); // Orange if not (0xFF9800 -> RGB)
            }
            g.noStroke();
            g.ellipse(370, 20, 8, 8);
            
        } catch (Exception e) {
            System.err.println("Error in drawStatusBar: " + e.getMessage());
            // Fallback: just draw a simple status
            g.fill(255);
            g.textAlign(g.LEFT, g.TOP);
            g.textSize(12);
            g.text("Status Error", 15, 15);
        }
    }
    
    /**
     * „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÈÄ≤Ë°åÂ∫¶„ÇíÊõ¥Êñ∞„Åô„Çã„ÄÇ
     */
    private void updatePageAnimation() {
        if (!isAnimating) {
            return;
        }
        
        long currentTime = System.currentTimeMillis();
        long elapsed = currentTime - animationStartTime;
        
        if (elapsed >= ANIMATION_DURATION) {
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü
            completePageTransition();
        } else {
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈÄ≤Ë°å‰∏≠ - „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞„ÇíÈÅ©Áî®
            float t = (float) elapsed / ANIMATION_DURATION;
            animationProgress = easeOutCubic(t);
            
            // „Éö„Éº„Ç∏„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆó
            if (targetPageIndex == animationBasePageIndex) {
                // ÂÖÉ„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ - „Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„Åã„Çâ0„Å´Êàª„Çã
                pageTransitionOffset = startOffset * (1.0f - animationProgress);
            } else {
                // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ - ÈñãÂßã‰ΩçÁΩÆ„Åã„ÇâÁõÆÊ®ô‰ΩçÁΩÆ„Å∏„ÅÆË£úÈñì
                float targetOffset = (animationBasePageIndex - targetPageIndex) * 400;
                pageTransitionOffset = startOffset + (targetOffset - startOffset) * animationProgress;
                System.out.println("üé¨ Animation: basePage=" + animationBasePageIndex + " to targetPage=" + targetPageIndex + 
                                 ", startOffset=" + startOffset + ", targetOffset=" + targetOffset + ", progress=" + animationProgress + ", offset=" + pageTransitionOffset);
            }
        }
    }
    
    /**
     * „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞Ôºàease-out quad - „Çà„ÇäÁ©è„ÇÑ„ÅãÔºâ
     * 
     * @param t ÈÄ≤Ë°åÂ∫¶ (0.0 ÔΩû 1.0)
     * @return „Ç§„Éº„Ç∏„É≥„Ç∞ÈÅ©Áî®Âæå„ÅÆÂÄ§
     */
    private float easeOutCubic(float t) {
        // ease-out quadratic - „Çà„ÇäËá™ÁÑ∂„ÅßÁ©è„ÇÑ„Åã„Å™Âãï„Åç
        return 1 - (1 - t) * (1 - t);
    }
    
    /**
     * „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÆå‰∫Ü„Åô„Çã„ÄÇ
     */
    private void completePageTransition() {
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÊôÇ„Å´„Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÊõ¥Êñ∞„Åó„ÄÅÂ∫ßÊ®ôÁ≥ª„Çí„É™„Çª„ÉÉ„Éà
        System.out.println("üé¨ Completing transition: currentPage=" + currentPageIndex + " -> targetPage=" + targetPageIndex);
        
        // „Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÁõÆÊ®ô„Å´Êõ¥Êñ∞
        currentPageIndex = targetPageIndex;
        
        // Â∫ßÊ®ôÁ≥ª„Çí„É™„Çª„ÉÉ„Éà
        pageTransitionOffset = 0.0f;
        isAnimating = false;
        animationProgress = 0.0f;
        startOffset = 0.0f;
        
        System.out.println("üé¨ Page transition completed to page " + currentPageIndex + ", offset reset to 0");

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÈÅÖÂª∂„Åï„Çå„Åü„Éâ„É≠„ÉÉ„Éó„ÇíÂÆüË°å
        executePendingDrop();
    }
    
    /**
     * „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åô„Çã„ÄÇ
     * 
     * @param newPageIndex ÁõÆÊ®ô„Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
     */
    private void startPageTransition(int newPageIndex) {
        if (newPageIndex == currentPageIndex || isAnimating) {
            return; // Âêå„Åò„Éö„Éº„Ç∏„Åæ„Åü„ÅØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅØÁÑ°Ë¶ñ
        }
        
        targetPageIndex = newPageIndex;
        isAnimating = true;
        animationStartTime = System.currentTimeMillis();
        animationProgress = 0.0f;
        startOffset = pageTransitionOffset; // ÁèæÂú®„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
        animationBasePageIndex = currentPageIndex; // Â∫ßÊ®ôË®àÁÆó„ÅÆÂü∫Ê∫ñ„Éö„Éº„Ç∏„ÇíÂõ∫ÂÆö
        
        System.out.println("üé¨ Starting page transition from " + currentPageIndex + " to " + targetPageIndex + " with startOffset=" + startOffset + ", basePageIndex=" + animationBasePageIndex);
    }
    
    /**
     * Draws pages with smooth transition animation using matrix transformation.
     * 
     * @param p The PApplet instance for drawing
     */
    private void drawPagesWithTransition(PGraphics g) {
        if (homePages.isEmpty()) {
            // No pages, show message
            g.fill(255, 255, 255, 150);
            g.textAlign(g.CENTER, g.CENTER);
            g.textSize(16);
            g.text("No apps installed", 200, 300);
            g.textSize(12);
            g.text("Swipe up to access app library", 200, 320);
            return;
        }
        
        // Â∫ßÊ®ôÂ§âÊèõ„Åß„Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÆüÁèæ
        g.pushMatrix();

        // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíÈÅ©Áî®
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅØÂü∫Ê∫ñ„Éö„Éº„Ç∏ÔºàanimationBasePageIndexÔºâ„Çí‰ΩøÁî®„Åó„Å¶„Ç∏„É£„É≥„Éó„ÇíÈò≤„Åê
        int basePageForOffset = isAnimating ? animationBasePageIndex : currentPageIndex;
        float totalOffset = -basePageForOffset * 400 + pageTransitionOffset;
        g.translate(totalOffset, 0);
        
        if (isAnimating) {
            System.out.println("üé® Drawing with basePageIndex=" + basePageForOffset + ", pageTransitionOffset=" + pageTransitionOffset + ", totalOffset=" + totalOffset);
        }
        
        // ÂÖ®„Éö„Éº„Ç∏„ÇíÊ®™„Å´‰∏¶„Åπ„Å¶ÊèèÁîª
        for (int i = 0; i < homePages.size(); i++) {
            g.pushMatrix();
            g.translate(i * 400, 0); // ÂêÑ„Éö„Éº„Ç∏„Çí400pxÈñìÈöî„ÅßÈÖçÁΩÆ
            
            HomePage page = homePages.get(i);
            if (page.isAppLibraryPage()) {
                drawAppLibraryPage(g, page);
            } else {
                drawNormalPage(g, page);
            }
            
            g.popMatrix();
        }
        
        g.popMatrix();

        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÊúÄ‰∏ä‰Ωç„É¨„Ç§„É§„ÉºÔºàÂ§âÊèõ„Å™„ÅóÔºâ„ÅßÊèèÁîª
        if (isDragging && draggedShortcut != null) {
            drawDraggedShortcut(g, draggedShortcut);
        }
    }
    
    /**
     * „Éû„Ç¶„ÇπÂ∫ßÊ®ô„Çí„Éö„Éº„Ç∏Â∫ßÊ®ôÁ≥ª„Å´Â§âÊèõ„Åô„Çã„ÄÇ
     * 
     * @param mouseX „Éû„Ç¶„ÇπXÂ∫ßÊ®ô
     * @param mouseY „Éû„Ç¶„ÇπYÂ∫ßÊ®ô
     * @return [Â§âÊèõÂæåXÂ∫ßÊ®ô, Â§âÊèõÂæåYÂ∫ßÊ®ô, „Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ]
     */
    private int[] transformMouseCoordinates(int mouseX, int mouseY) {
        // ÁèæÂú®„ÅÆÂ§âÊèõË°åÂàó„ÇíËÄÉÊÖÆ„Åó„Å¶„Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíÂ§âÊèõ
        float totalOffset = -currentPageIndex * 400 + pageTransitionOffset;
        float transformedX = mouseX - totalOffset;
        
        // „Å©„ÅÆ„Éö„Éº„Ç∏‰∏ä„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Åã„ÇíÂà§ÂÆö
        int targetPageIndex = (int) (transformedX / 400);
        if (targetPageIndex < 0) targetPageIndex = 0;
        if (targetPageIndex >= homePages.size()) targetPageIndex = homePages.size() - 1;
        
        // „Éö„Éº„Ç∏ÂÜÖÂ∫ßÊ®ô„Å´Â§âÊèõ
        float pageX = transformedX - (targetPageIndex * 400);
        
        return new int[]{(int) pageX, mouseY, targetPageIndex};
    }
    
    /**
     * Draws a normal home page with shortcuts.
     * 
     * @param p The PApplet instance for drawing
     * @param page The page to draw
     */
    private void drawNormalPage(PGraphics g, HomePage page) {
        // ÈÄöÂ∏∏„ÅÆ„Éö„Éº„Ç∏ÊèèÁîªÂá¶ÁêÜ
        int startY = 80; // Below status bar
        int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
        int startX = (400 - gridWidth) / 2; // Center the grid
        
        g.textAlign(g.CENTER, g.TOP);
        g.textSize(10);
        
        // First draw non-dragged shortcuts
        for (Shortcut shortcut : page.getShortcuts()) {
            if (shortcut.isDragging()) continue; // Draw dragged shortcuts last
            
            int x = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
            int y = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20); // Extra space for app name
            
            // Apply wiggle animation if in edit mode
            if (isEditing) {
                x += (int) (Math.sin(System.currentTimeMillis() * 0.01 + shortcut.getShortcutId().hashCode()) * 2);
                y += (int) (Math.cos(System.currentTimeMillis() * 0.012 + shortcut.getShortcutId().hashCode()) * 1.5);
            }
            
            // Draw shortcut
            drawShortcut(g, shortcut, x, y);
        }
        
        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅØÊúÄ‰∏ä‰Ωç„É¨„Ç§„É§„Éº„ÅßÊèèÁîª„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        // (drawPagesWithTransition„ÅÆÊúÄÂæå„ÅßÊèèÁîª„Åï„Çå„Çã)
        
        // Draw drop target indicators if dragging
        if (isDragging) {
            drawDropTargets(g, startX, startY);
        }
    }
    
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„ÇíÊèèÁîª„Åô„Çã„ÄÇ
     * 
     * @param p The PApplet instance for drawing
     * @param appLibraryPage AppLibrary„Éö„Éº„Ç∏
     */
    private void drawAppLibraryPage(PGraphics g, HomePage appLibraryPage) {
        System.out.println("üé® HomeScreen: drawAppLibraryPage() called - drawing AppLibrary content");
        
        // AppLibrary„Çø„Ç§„Éà„É´„ÇíÊèèÁîª
        g.fill(255, 255, 255); // ÁôΩËâ≤„ÉÜ„Ç≠„Çπ„Éà (0xFFFFFF -> RGB)
        g.textAlign(g.CENTER, g.TOP);
        g.textSize(18);
        System.out.println("üé® Drawing title: 'App Library' at (200, 70) with size 18, color RGB(255,255,255)");
        g.text("App Library", 200, 70);
        System.out.println("üé® Title drawing completed");

        // „Ç¢„Éó„É™„É™„Çπ„Éà„ÇíÊèèÁîª
        List<IApplication> apps = appLibraryPage.getAllApplications();
        System.out.println("üé® AppLibrary apps count: " + apps.size());
        if (apps.isEmpty()) {
            g.fill(255, 255, 255, 150); // textColor with alpha -> RGB
            g.textAlign(g.CENTER, g.CENTER);
            g.textSize(14);
            g.text("No apps available", 200, 300);
            System.out.println("üé® 'No apps available' message drawn at (200, 300)");
            return;
        }
        
        int startY = 110; // „Çø„Ç§„Éà„É´„ÅÆ‰∏ã„Åã„ÇâÈñãÂßã
        int listHeight = 600 - startY - NAV_AREA_HEIGHT - 20; // Âà©Áî®ÂèØËÉΩ„Å™È´ò„Åï
        int itemHeight = 70; // ÂêÑ„Ç¢„Éó„É™„Ç¢„Ç§„ÉÜ„É†„ÅÆÈ´ò„Åï
        int scrollOffset = appLibraryPage.getScrollOffset();
        System.out.println("üé® Drawing " + apps.size() + " apps starting at Y=" + startY + ", scrollOffset=" + scrollOffset);
        
        // „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢„ÇíË®≠ÂÆöÔºà„ÇØ„É™„ÉÉ„Éî„É≥„Ç∞Ôºâ
        g.pushMatrix();
        
        // „Ç¢„Éó„É™„É™„Çπ„Éà„ÇíÊèèÁîª
        for (int i = 0; i < apps.size(); i++) {
            IApplication app = apps.get(i);
            int itemY = startY + i * itemHeight - scrollOffset;
            
            // Ë°®Á§∫„Ç®„É™„Ç¢Â§ñ„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (itemY + itemHeight < startY || itemY > startY + listHeight) {
                continue;
            }
            
            drawAppLibraryItem(g, app, 20, itemY, 360, itemHeight);
        }
        
        g.popMatrix();
        
        // „Çπ„ÇØ„É≠„Éº„É´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊèèÁîª
        if (appLibraryPage.needsScrolling(listHeight, itemHeight)) {
            drawScrollIndicator(g, appLibraryPage, startY, listHeight, itemHeight);
        }
    }
    
    /**
     * AppLibrary„ÅÆ„Ç¢„Éó„É™„Ç¢„Ç§„ÉÜ„É†„ÇíÊèèÁîª„Åô„Çã„ÄÇ
     * 
     * @param p The PApplet instance for drawing
     * @param app ÊèèÁîª„Åô„Çã„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
     * @param x „Ç¢„Ç§„ÉÜ„É†„ÅÆXÂ∫ßÊ®ô
     * @param y „Ç¢„Ç§„ÉÜ„É†„ÅÆYÂ∫ßÊ®ô
     * @param width „Ç¢„Ç§„ÉÜ„É†„ÅÆÂπÖ
     * @param height „Ç¢„Ç§„ÉÜ„É†„ÅÆÈ´ò„Åï
     */
    private void drawAppLibraryItem(PGraphics g, IApplication app, int x, int y, int width, int height) {
        // „Ç¢„Ç§„ÉÜ„É†„ÅÆËÉåÊôØ
        g.fill(58, 58, 58, 100); // 0x3A3A3A -> RGB with alpha
        g.noStroke();
        g.rect(x, y, width, height, 8);

        // „Ç¢„Éó„É™„Ç¢„Ç§„Ç≥„É≥
        g.fill(74, 144, 226); // accentColor (0x4A90E2) -> RGB
        g.rect(x + 10, y + 10, 50, 50, 8);

        // „Ç¢„Éó„É™Âêç„ÅÆÊúÄÂàù„ÅÆÊñáÂ≠ó
        g.fill(255, 255, 255); // textColor -> RGB
        g.textAlign(g.CENTER, g.CENTER);
        g.textSize(24);
        String initial = app.getName().substring(0, 1).toUpperCase();
        g.text(initial, x + 35, y + 35);

        // „Ç¢„Éó„É™Âêç
        g.fill(255, 255, 255); // textColor -> RGB
        g.textAlign(g.LEFT, g.CENTER);
        g.textSize(16);
        g.text(app.getName(), x + 75, y + 25);

        // „Ç¢„Éó„É™Ë™¨ÊòéÔºà„ÅÇ„Çå„Å∞Ôºâ
        if (app.getDescription() != null && !app.getDescription().isEmpty()) {
            g.fill(255, 255, 255, 150); // textColor with alpha -> RGB
            g.textSize(12);
            String description = app.getDescription();
            if (description.length() > 40) {
                description = description.substring(0, 37) + "...";
            }
            g.text(description, x + 75, y + 45);
        }
        
        // Èï∑Êäº„ÅóÊôÇ„ÅÆ„Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Éú„Çø„É≥„ÇíÊèèÁîª
        // ÔºàÂÆüË£Ö„ÅØÂæå„ÅßËøΩÂä†Ôºâ
    }
    
    /**
     * „Çπ„ÇØ„É≠„Éº„É´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÊèèÁîª„Åô„Çã„ÄÇ
     * 
     * @param p The PApplet instance for drawing
     * @param appLibraryPage AppLibrary„Éö„Éº„Ç∏
     * @param listStartY „É™„Çπ„ÉàÈñãÂßãYÂ∫ßÊ®ô
     * @param listHeight „É™„Çπ„Éà„ÅÆÈ´ò„Åï
     * @param itemHeight „Ç¢„Ç§„ÉÜ„É†È´ò„Åï
     */
    private void drawScrollIndicator(PGraphics g, HomePage appLibraryPage, int listStartY, int listHeight, int itemHeight) {
        List<IApplication> apps = appLibraryPage.getAllApplications();
        int totalHeight = apps.size() * itemHeight;
        int scrollOffset = appLibraryPage.getScrollOffset();
        
        // „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ‰ΩçÁΩÆ„Å®„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
        float scrollbarHeight = Math.max(20, (float) listHeight * listHeight / totalHeight);
        float scrollbarY = listStartY + (float) scrollOffset * listHeight / totalHeight;
        
        // „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÇíÊèèÁîª
        g.fill(255, 255, 255, 100); // textColor with alpha -> RGB
        g.noStroke();
        g.rect(385, (int) scrollbarY, 6, (int) scrollbarHeight, 3);
    }
    
    /**
     * „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÁµ∂ÂØæÂ∫ßÊ®ô„ÅßÊèèÁîª„Åô„Çã„ÄÇ
     * Â∫ßÊ®ôÂ§âÊèõ„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Åö„Å´„Éû„Ç¶„Çπ‰ΩçÁΩÆ„Å´Ê≠£Á¢∫„Å´ËøΩÂæì„Åô„Çã„ÄÇ
     * 
     * @param p The PApplet instance for drawing
     * @param shortcut The dragged shortcut
     */
    private void drawDraggedShortcut(PGraphics g, Shortcut shortcut) {
        if (!shortcut.isDragging()) return;
        
        int x = (int) shortcut.getDragX();
        int y = (int) shortcut.getDragY();
        
        // „Éâ„É≠„ÉÉ„Éó„Ç∑„É£„Éâ„Ç¶„ÇíÊèèÁîª
        g.fill(0, 0, 0, 100);
        g.noStroke();
        g.rect(x + 4, y + 4, ICON_SIZE, ICON_SIZE, 12);

        // „Ç¢„Ç§„Ç≥„É≥„ÅÆËÉåÊôØ„ÇíÊèèÁîªÔºàÂçäÈÄèÊòéÔºâ
        g.fill(255, 255, 255, 220);
        g.stroke(85, 85, 85);
        g.strokeWeight(2);
        g.rect(x, y, ICON_SIZE, ICON_SIZE, 12);

        // „Ç¢„Éó„É™„Ç¢„Ç§„Ç≥„É≥„ÇíÊèèÁîª
        IApplication app = shortcut.getApplication();
        if (app != null) {
            drawAppIcon(g, app, x + ICON_SIZE/2, y + ICON_SIZE/2);
        }

        // „Ç¢„Éó„É™Âêç„ÇíÊèèÁîªÔºà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÇÇÂêå„Åò„Çπ„Çø„Ç§„É´Ôºâ
        g.noStroke();
        g.textAlign(g.CENTER, g.TOP); // ‰∏≠Â§ÆÈÖçÁΩÆ„ÄÅ‰∏äË©∞„ÇÅ
        g.textSize(11); // „É°„Ç§„É≥„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Å®Âêå„Åò„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
        
        String displayName = shortcut.getDisplayName();
        if (displayName.length() > 10) {
            displayName = displayName.substring(0, 9) + "...";
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂΩ±„ÇíËøΩÂä†Ôºà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÇÇÂèØË™≠ÊÄßÂêë‰∏äÔºâ
        g.fill(0, 0, 0, 120); // Â∞ë„ÅóÊøÉ„ÅÑÂΩ±
        g.text(displayName, x + ICON_SIZE/2 + 1, y + ICON_SIZE + 9);

        // „É°„Ç§„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
        g.fill(255, 255, 255); // ÁôΩËâ≤„ÉÜ„Ç≠„Çπ„Éà
        g.text(displayName, x + ICON_SIZE/2, y + ICON_SIZE + 8);
    }
    
    /**
     * Draws drop target indicators during drag operation.
     * 
     * @param p The PApplet instance for drawing
     * @param startX Grid start X position
     * @param startY Grid start Y position
     */
    private void drawDropTargets(PGraphics g, int startX, int startY) {
        HomePage currentPage = getCurrentPage();
        if (currentPage == null) return;
        
        g.stroke(accentColor, 150);
        g.strokeWeight(2);
        g.noFill();
        
        // Draw indicators for empty positions
        for (int gridX = 0; gridX < GRID_COLS; gridX++) {
            for (int gridY = 0; gridY < GRID_ROWS; gridY++) {
                if (currentPage.isPositionEmpty(gridX, gridY)) {
                    int x = startX + gridX * (ICON_SIZE + ICON_SPACING);
                    int y = startY + gridY * (ICON_SIZE + ICON_SPACING + 20);
                    
                    g.rect(x, y, ICON_SIZE, ICON_SIZE, 12);
                }
            }
        }
    }
    
    /**
     * Draws an individual shortcut.
     * 
     * @param p The PApplet instance for drawing
     * @param shortcut The shortcut to draw
     * @param x The x coordinate for the shortcut
     * @param y The y coordinate for the shortcut
     */
    private void drawShortcut(PGraphics g, Shortcut shortcut, int x, int y) {
        IApplication app = shortcut.getApplication();
        
        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅØÂ∞ÇÁî®„É°„ÇΩ„ÉÉ„Éâ„ÅßÊèèÁîª„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØÊèèÁîª„Åó„Å™„ÅÑ
        if (shortcut.isDragging()) {
            return;
        }
        
        // Draw app icon background
        g.fill(255);
        g.stroke(0x555555);
        g.strokeWeight(1);
        g.rect(x, y, ICON_SIZE, ICON_SIZE, 12);
        
        // Draw app icon
        drawAppIcon(g, app, x + ICON_SIZE/2, y + ICON_SIZE/2);
        
        // Draw delete button if in edit mode
        if (isEditing) {
            g.fill(0xFF4444); // Red delete button
            g.noStroke();
            g.ellipse(x + ICON_SIZE - 8, y + 8, 16, 16);
            
            // Draw X
            g.fill(textColor);
            g.strokeWeight(2);
            g.stroke(textColor);
            g.line(x + ICON_SIZE - 12, y + 4, x + ICON_SIZE - 4, y + 12);
            g.line(x + ICON_SIZE - 12, y + 12, x + ICON_SIZE - 4, y + 4);
        }
        
        // Draw app name below the icon
        g.fill(255, 255, 255); // ÁôΩËâ≤„ÉÜ„Ç≠„Çπ„Éà„ÅßË¶ñË™çÊÄßÂêë‰∏ä
        g.noStroke();
        g.textAlign(g.CENTER, g.TOP); // ‰∏≠Â§ÆÈÖçÁΩÆ„ÄÅ‰∏äË©∞„ÇÅ
        g.textSize(11); // ÈÅ©Âàá„Å™„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
        
        String displayName = shortcut.getDisplayName();
        if (displayName.length() > 10) {
            displayName = displayName.substring(0, 9) + "...";
        }
        
        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÂΩ±„ÇíËøΩÂä†„Åó„Å¶ÂèØË™≠ÊÄßÂêë‰∏ä
        g.fill(0, 0, 0, 100); // ÂçäÈÄèÊòé„ÅÆÈªí„ÅÑÂΩ±
        g.text(displayName, x + ICON_SIZE/2 + 1, y + ICON_SIZE + 9);
        
        // „É°„Ç§„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
        g.fill(255, 255, 255); // ÁôΩËâ≤„ÉÜ„Ç≠„Çπ„Éà
        g.text(displayName, x + ICON_SIZE/2, y + ICON_SIZE + 8);
    }
    
    /**
     * Draws an individual app icon.
     * If the application provides an icon image, it is drawn.
     * Otherwise, a placeholder is drawn.
     *
     * @param p The PApplet instance for drawing
     * @param app The application to draw an icon for
     * @param centerX The center X coordinate for the icon
     * @param centerY The center Y coordinate for the icon
     */
    private void drawAppIcon(PGraphics g, IApplication app, int centerX, int centerY) {
        if (app == null) {
            return;
        }

        processing.core.PImage icon = app.getIcon(g);

        if (icon != null) {
            g.imageMode(PGraphics.CENTER);
            // Draw the icon, ensuring it fits within the icon size with some padding
            float padding = 8;
            float drawableSize = ICON_SIZE - padding * 2;
            g.image(icon, centerX, centerY, drawableSize, drawableSize);
            g.imageMode(PGraphics.CORNER); // Reset image mode to default
        } else {
            // Fallback to placeholder if icon is null
            g.rectMode(PGraphics.CENTER);
            g.fill(accentColor);
            g.noStroke();
            g.rect(centerX, centerY, 40, 40, 8);
            
            // Draw app initial
            g.fill(textColor);
            g.textAlign(g.CENTER, g.CENTER);
            g.textSize(20);
            if (app.getName() != null && !app.getName().isEmpty()) {
                String initial = app.getName().substring(0, 1).toUpperCase();
                g.text(initial, centerX, centerY - 2);
            }
            g.rectMode(PGraphics.CORNER); // Reset rect mode to default
        }
    }
    
    /**
     * Draws the navigation area at the bottom for accessing app library.
     * 
     * @param p The PApplet instance for drawing
     */
    private void drawNavigationArea(PGraphics g) {
        int navY = 600 - NAV_AREA_HEIGHT;
        
        // Draw navigation background
        g.fill(0x2A2A2A);
        g.noStroke();
        g.rect(0, navY, 400, NAV_AREA_HEIGHT);
        
        // Draw app library access hint
        g.fill(textColor, 150);
        g.textAlign(g.CENTER, g.CENTER);
        g.textSize(14);
        g.text("App Library", 200, navY + 30);
        
        // Draw edit mode toggle hint if not in edit mode
        if (!isEditing) {
            g.textSize(10);
            g.text("Long press to edit", 200, navY + 50);
        } else {
            g.textSize(10);
            g.text("Tap outside to finish editing", 200, navY + 50);
        }
        
        // Draw swipe indicator for pages if multiple pages exist
        if (homePages.size() > 1) {
            g.stroke(textColor, 100);
            g.strokeWeight(1);
            g.noFill();
            
            // Left arrow for previous page
            if (currentPageIndex > 0) {
                g.line(50, navY + 70, 40, navY + 75);
                g.line(50, navY + 70, 40, navY + 65);
            }
            
            // Right arrow for next page
            if (currentPageIndex < homePages.size() - 1) {
                g.line(350, navY + 70, 360, navY + 75);
                g.line(350, navY + 70, 360, navY + 65);
            }
        }
    }
    
    /**
     * Draws page indicator dots for multiple pages.
     * 
     * @param p The PApplet instance for drawing
     */
    private void drawPageIndicators(PGraphics g) {
        if (homePages.size() <= 1) {
            return; // Don't show indicators for single page
        }
        
        int dotY = 600 - NAV_AREA_HEIGHT - 25; // Â∞ë„Åó‰∏ä„Å´ÁßªÂãï
        int dotSize = 10;
        int activeDotSize = 14;
        int spacing = 20;
        int totalWidth = homePages.size() * spacing - (spacing - dotSize);
        int startX = (400 - totalWidth) / 2;
        
        // ËÉåÊôØ„ÅÆÂçäÈÄèÊòé„Ç®„É™„Ç¢
        g.fill(0, 0, 0, 100);
        g.noStroke();
        g.rect(startX - 15, dotY - 10, totalWidth + 30, 20, 10);
        
        for (int i = 0; i < homePages.size(); i++) {
            int dotX = startX + i * spacing;
            
            if (i == currentPageIndex) {
                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏ - Â§ß„Åç„ÅèÊòé„Çã„Åè
                g.fill(74, 144, 226); // „Ç¢„ÇØ„Çª„É≥„Éà„Ç´„É©„Éº (accentColor RGB)
                g.noStroke();
                g.ellipse(dotX, dotY, activeDotSize, activeDotSize);
                
                // Â§ñÂÅ¥„ÅÆ„É™„É≥„Ç∞
                g.noFill();
                g.stroke(74, 144, 226, 150);
                g.strokeWeight(2);
                g.ellipse(dotX, dotY, activeDotSize + 4, activeDotSize + 4);
            } else {
                // ‰ªñ„ÅÆ„Éö„Éº„Ç∏ - Â∞è„Åï„ÅèËñÑ„Åè
                g.fill(255, 255, 255, 120);
                g.noStroke();
                g.ellipse(dotX, dotY, dotSize, dotSize);
            }
        }
        
        // AppLibrary„Éö„Éº„Ç∏„Å´„ÅØÁâπÂà•„Å™„Ç¢„Ç§„Ç≥„É≥
        for (int i = 0; i < homePages.size(); i++) {
            HomePage page = homePages.get(i);
            if (page.isAppLibraryPage()) {
                int dotX = startX + i * spacing;
                
                // AppLibrary„Ç¢„Ç§„Ç≥„É≥Ôºà„Ç∞„É™„ÉÉ„ÉâÈ¢®Ôºâ
                g.stroke(i == currentPageIndex ? 255 : 200);
                g.strokeWeight(1);
                g.noFill();
                
                // Â∞è„Åï„Å™3x3„Ç∞„É™„ÉÉ„Éâ
                int gridSize = 6;
                for (int row = 0; row < 3; row++) {
                    for (int col = 0; col < 3; col++) {
                        int x = dotX - gridSize + col * (gridSize / 2);
                        int y = dotY - gridSize + row * (gridSize / 2);
                        g.rect(x, y, 1, 1);
                    }
                }
                break;
            }
        }
    }
    
    /**
     * Gets the shortcut at the specified coordinates on a specific page.
     * 
     * @param x The x coordinate
     * @param y The y coordinate
     * @param page The page to search
     * @return The Shortcut at that position, or null if none
     */
    private Shortcut getShortcutAtPosition(int x, int y, HomePage page) {
        if (page == null || page.isAppLibraryPage()) {
            return null;
        }
        
        int startY = 80;
        int gridWidth = GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING;
        int startX = (400 - gridWidth) / 2;
        
        for (Shortcut shortcut : page.getShortcuts()) {
            int iconX = startX + shortcut.getGridX() * (ICON_SIZE + ICON_SPACING);
            int iconY = startY + shortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20);
            
            if (x >= iconX && x <= iconX + ICON_SIZE && 
                y >= iconY && y <= iconY + ICON_SIZE) {
                return shortcut;
            }
        }
        
        return null;
    }
    
    /**
     * Gets the shortcut at the specified screen coordinates (legacy method).
     * 
     * @param x The x coordinate
     * @param y The y coordinate
     * @return The Shortcut at that position, or null if none
     */
    private Shortcut getShortcutAtPosition(int x, int y) {
        HomePage currentPage = getCurrentPage();
        return getShortcutAtPosition(x, y, currentPage);
    }
    
    /**
     * Gets the application at the specified screen coordinates.
     * 
     * @param x The x coordinate
     * @param y The y coordinate
     * @return The IApplication at that position, or null if none
     */
    private IApplication getAppAtPosition(int x, int y) {
        Shortcut shortcut = getShortcutAtPosition(x, y);
        return shortcut != null ? shortcut.getApplication() : null;
    }
    
    /**
     * „Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíÂ∫ßÊ®ôÂ§âÊèõÂæå„ÅÆÂ∫ßÊ®ô„Å´Â§âÊèõ„Åó„ÄÅÈÅ©Âàá„Å™„Éö„Éº„Ç∏„Åß„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÊ§úÁ¥¢„Åô„Çã„ÄÇ
     * 
     * @param mouseX „Éû„Ç¶„ÇπXÂ∫ßÊ®ôÔºàÁµ∂ÂØæÂ∫ßÊ®ôÔºâ
     * @param mouseY „Éû„Ç¶„ÇπYÂ∫ßÊ®ôÔºàÁµ∂ÂØæÂ∫ßÊ®ôÔºâ
     * @return Ë©≤ÂΩì‰ΩçÁΩÆ„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÄÅ„Åæ„Åü„ÅØ null
     */
    private Shortcut getShortcutAtPositionWithTransform(int mouseX, int mouseY) {
        // ÁèæÂú®„ÅÆÂ∫ßÊ®ôÂ§âÊèõ„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆó
        int basePageForOffset = isAnimating ? animationBasePageIndex : currentPageIndex;
        float totalOffset = -basePageForOffset * 400 + pageTransitionOffset;
        
        // „Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíÂ§âÊèõÂæå„ÅÆÂ∫ßÊ®ôÁ≥ª„Å´Ë™øÊï¥
        float transformedX = mouseX - totalOffset;
        
        // „Å©„ÅÆ„Éö„Éº„Ç∏ÁØÑÂõ≤„Å´„ÅÑ„Çã„Åã„ÇíÂà§ÂÆö
        int pageIndex = (int) Math.floor(transformedX / 400);
        
        // „Éö„Éº„Ç∏ÁØÑÂõ≤ÂÜÖ„Åß„ÅÆ„É≠„Éº„Ç´„É´Â∫ßÊ®ô„ÇíË®àÁÆó
        int localX = (int) (transformedX - pageIndex * 400);
        
        // „Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåÊúâÂäπÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (pageIndex >= 0 && pageIndex < homePages.size()) {
            HomePage targetPage = homePages.get(pageIndex);
            return getShortcutAtPosition(localX, mouseY, targetPage);
        }
        
        return null;
    }
    
    /**
     * Opens the app library by switching to the App Library page within the home screen.
     */
    private void openAppLibrary() {
        System.out.println("HomeScreen: Navigating to integrated App Library page");
        
        // AppLibrary„Éö„Éº„Ç∏ÔºàÊúÄÂæå„ÅÆ„Éö„Éº„Ç∏Ôºâ„Å´Âàá„ÇäÊõø„Åà
        if (!homePages.isEmpty()) {
            int appLibraryPageIndex = homePages.size() - 1;
            if (appLibraryPageIndex != currentPageIndex && !isAnimating) {
                startPageTransition(appLibraryPageIndex);
            }
        }
    }
    
    /**
     * Launches the specified application.
     * 
     * @param app The application to launch
     */
    private void launchApplication(IApplication app) {
        System.out.println("HomeScreen: Launching app: " + app.getName());
        
        if (kernel != null && kernel.getScreenManager() != null) {
            try {
                Screen appScreen = app.getEntryScreen(kernel);
                kernel.getScreenManager().pushScreen(appScreen);
            } catch (Exception e) {
                System.err.println("HomeScreen: Failed to launch app " + app.getName() + ": " + e.getMessage());
                e.printStackTrace();
            }
        }
    }
    
    /**
     * „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„Åß„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíËµ∑Âãï„Åô„Çã
     */
    private void launchApplicationWithAnimation(IApplication app, float iconX, float iconY, float iconSize) {
        System.out.println("HomeScreen: Launching app with animation: " + app.getName());
        System.out.println("HomeScreen: Icon position: (" + iconX + ", " + iconY + "), size: " + iconSize);
        
        if (kernel != null && kernel.getScreenManager() != null) {
            try {
                Screen appScreen = app.getEntryScreen(kernel);
                System.out.println("HomeScreen: Got app screen: " + appScreen.getScreenTitle());
                
                // Get app icon for animation
                processing.core.PImage appIcon = null;
                if (kernel != null) {
                    // Use PGraphics-based icon retrieval
                    processing.core.PGraphics graphics = kernel.getGraphics();
                    if (graphics != null) {
                        appIcon = app.getIcon(graphics);
                        System.out.println("HomeScreen: Got app icon: " + (appIcon != null ? appIcon.width + "x" + appIcon.height : "null"));
                    } else {
                        System.out.println("HomeScreen: Kernel graphics is null");
                    }
                } else {
                    System.out.println("HomeScreen: Kernel is null");
                }
                
                // Launch with animation
                if (appIcon != null) {
                    System.out.println("HomeScreen: Calling pushScreenWithAnimation...");
                    kernel.getScreenManager().pushScreenWithAnimation(appScreen, iconX, iconY, iconSize, appIcon);
                } else {
                    System.out.println("HomeScreen: No icon available, using normal launch");
                    // Fallback to normal launch
                    kernel.getScreenManager().pushScreen(appScreen);
                }
            } catch (Exception e) {
                System.err.println("HomeScreen: Failed to launch app with animation " + app.getName() + ": " + e.getMessage());
                e.printStackTrace();
            }
        }
    }
    
    /**
     * Refreshes the home screen pages.
     */
    public void refreshApps() {
        System.out.println("HomeScreen: refreshApps() called - reinitializing pages...");
        initializeHomePages();
        currentPageIndex = 0;
        isEditing = false;
        System.out.println("HomeScreen: Refreshed home screen pages - total pages: " + homePages.size());
    }
    
    /**
     * Toggles edit mode.
     */
    public void toggleEditMode() {
        isEditing = !isEditing;
        System.out.println("HomeScreen: Edit mode " + (isEditing ? "enabled" : "disabled"));

        if (isEditing) {
            // Á∑®ÈõÜ„É¢„Éº„ÉâÈñãÂßãÊôÇ„Å´Á©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÊúÄÂæå„Å´ËøΩÂä†
            addEmptyPageIfNeeded();
        } else {
            // Á∑®ÈõÜ„É¢„Éº„ÉâÁµÇ‰∫ÜÊôÇ„Å´„ÅØ„Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            resetDragState();
            System.out.println("HomeScreen: Reset drag state on edit mode exit");

            // Á∑®ÈõÜ„É¢„Éº„ÉâÁµÇ‰∫ÜÊôÇ„Å´Á©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§
            removeEmptyPagesAtEnd();
        }
    }
    
    /**
     * Adds a new page to the home screen.
     */
    public void addNewPage() {
        HomePage newPage = new HomePage();
        homePages.add(newPage);
        System.out.println("HomeScreen: Added new page, total pages: " + homePages.size());
    }

    /**
     * Adds an empty page at the end if needed (for edit mode).
     */
    private void addEmptyPageIfNeeded() {
        System.out.println("HomeScreen: addEmptyPageIfNeeded() called");
        System.out.println("HomeScreen: Total pages: " + homePages.size());

        // ÊúÄÂæå„ÅÆ„Éö„Éº„Ç∏„ÅåÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÊúÄÂæå„ÅåAppLibrary„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØÁ©∫„Éö„Éº„Ç∏„ÇíËøΩÂä†
        if (homePages.isEmpty()) {
            System.out.println("HomeScreen: No pages exist, adding first page");
            addNewPage();
            return;
        }

        // AppLibrary„Éö„Éº„Ç∏„ÅÆÂâç„Å´Á©∫„Éö„Éº„Ç∏„ÇíÊåøÂÖ•„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ„Å´Â§âÊõ¥
        int insertIndex = homePages.size();
        HomePage lastPage = homePages.get(homePages.size() - 1);

        System.out.println("HomeScreen: Last page type: " + (lastPage.isAppLibraryPage() ? "APP_LIBRARY" : "NORMAL"));
        System.out.println("HomeScreen: Last page shortcuts count: " + lastPage.getShortcuts().size());

        // AppLibrary„Éö„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÂâç„Å´ÊåøÂÖ•
        if (lastPage.isAppLibraryPage()) {
            insertIndex = homePages.size() - 1; // AppLibrary„Éö„Éº„Ç∏„ÅÆÂâç„Å´ÊåøÂÖ•

            // AppLibrary„Éö„Éº„Ç∏„ÅÆÂâç„ÅÆ„Éö„Éº„Ç∏„ÅåÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÁ©∫„Éö„Éº„Ç∏„ÇíËøΩÂä†
            if (insertIndex > 0) {
                HomePage secondToLastPage = homePages.get(insertIndex - 1);
                if (!secondToLastPage.getShortcuts().isEmpty()) {
                    HomePage newPage = new HomePage();
                    homePages.add(insertIndex, newPage);
                    System.out.println("HomeScreen: Added empty page before AppLibrary at index " + insertIndex);
                } else {
                    System.out.println("HomeScreen: Page before AppLibrary is already empty, no need to add");
                }
            } else {
                // AppLibrary„Éö„Éº„Ç∏„ÅåÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„ÅÆÂ†¥ÂêàÔºàÈÄöÂ∏∏„ÅØ„Å™„ÅÑÔºâ
                HomePage newPage = new HomePage();
                homePages.add(0, newPage);
                System.out.println("HomeScreen: Added empty page before AppLibrary at index 0");
            }
        } else {
            // ÊúÄÂæå„ÅÆ„Éö„Éº„Ç∏„ÅåÈÄöÂ∏∏„Éö„Éº„Ç∏„ÅßÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅÁ©∫„Éö„Éº„Ç∏„ÇíËøΩÂä†
            if (!lastPage.getShortcuts().isEmpty()) {
                addNewPage();
                System.out.println("HomeScreen: Added empty page at end");
            } else {
                System.out.println("HomeScreen: Last page is already empty, no need to add");
            }
        }
    }

    /**
     * Removes empty pages at the end (after edit mode ends).
     */
    private void removeEmptyPagesAtEnd() {
        System.out.println("HomeScreen: removeEmptyPagesAtEnd() called");
        System.out.println("HomeScreen: Total pages before cleanup: " + homePages.size());

        // AppLibrary„Éö„Éº„Ç∏„ÇíÈô§„ÅÑ„ÅüÈÄöÂ∏∏„Éö„Éº„Ç∏„ÅÆ‰∏≠„Åß„ÄÅÂæå„Çç„Åã„ÇâÁ©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§
        boolean removedAny = false;
        for (int i = homePages.size() - 1; i >= 0; i--) {
            HomePage page = homePages.get(i);

            // AppLibrary„Éö„Éº„Ç∏„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (page.isAppLibraryPage()) {
                System.out.println("HomeScreen: Skipping AppLibrary page at index " + i);
                continue;
            }

            // Á©∫„ÅÆ„Éö„Éº„Ç∏„ÇíÂâäÈô§
            if (page.getShortcuts().isEmpty()) {
                homePages.remove(i);
                removedAny = true;
                System.out.println("HomeScreen: Removed empty page at index " + i);

                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„ÅØË™øÊï¥
                if (currentPageIndex >= homePages.size()) {
                    currentPageIndex = Math.max(0, homePages.size() - 1);
                    System.out.println("HomeScreen: Adjusted current page index to " + currentPageIndex);
                }

                // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåÂâäÈô§„Åï„Çå„Åü„Éö„Éº„Ç∏‰ª•Èôç„ÅÆÂ†¥Âêà„ÅØË™øÊï¥
                if (currentPageIndex > i) {
                    currentPageIndex--;
                    System.out.println("HomeScreen: Decremented current page index to " + currentPageIndex);
                }
            } else {
                // Á©∫„Åß„Å™„ÅÑ„Éö„Éº„Ç∏„ÅåË¶ã„Å§„Åã„Å£„Åü„Çâ„ÄÅ‰ª•Èôç„ÅÆÂâäÈô§„ÅØÂÅúÊ≠¢
                // Ôºà„Åü„Å†„ÅóAppLibrary„Éö„Éº„Ç∏„ÅØÈô§Â§ñÔºâ
                System.out.println("HomeScreen: Found non-empty page at index " + i + ", stopping cleanup");
                break;
            }
        }

        if (!removedAny) {
            System.out.println("HomeScreen: No empty pages to remove");
        }

        System.out.println("HomeScreen: Total pages after cleanup: " + homePages.size());
    }
    
    /**
     * Gets the current page.
     * 
     * @return The current HomePage, or null if none
     */
    public HomePage getCurrentPage() {
        if (homePages.isEmpty() || currentPageIndex >= homePages.size()) {
            return null;
        }
        return homePages.get(currentPageIndex);
    }
    
    // ===========================================
    // GestureListener Implementation
    // ===========================================
    
    @Override
    public boolean onGesture(GestureEvent event) {
        System.out.println("HomeScreen: Received gesture: " + event);
        
        switch (event.getType()) {
            case TAP:
                return handleTap(event.getCurrentX(), event.getCurrentY());
                
            case LONG_PRESS:
                return handleLongPress(event.getCurrentX(), event.getCurrentY());
                
            case DRAG_START:
                return handleDragStart(event);
                
            case DRAG_MOVE:
                return handleDragMove(event);
                
            case DRAG_END:
                return handleDragEnd(event);
                
            case SWIPE_LEFT:
                return handleSwipeLeft();
                
            case SWIPE_RIGHT:
                return handleSwipeRight();
                
            case SWIPE_UP:
                return handleSwipeUp(event);
                
            default:
                return false; // Âá¶ÁêÜ„Åó„Å™„ÅÑ„Ç∏„Çß„Çπ„ÉÅ„É£„Éº
        }
    }
    
    @Override
    public boolean isInBounds(int x, int y) {
        // HomeScreen„ÅåÁèæÂú®„ÅÆ„Çπ„ÇØ„É™„Éº„É≥„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
        return kernel != null && 
               kernel.getScreenManager() != null && 
               kernel.getScreenManager().getCurrentScreen() == this;
    }
    
    @Override
    public int getPriority() {
        return 50; // ‰∏≠ÂÑ™ÂÖàÂ∫¶
    }
    
    /**
     * „Çø„ÉÉ„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param x XÂ∫ßÊ®ô
     * @param y YÂ∫ßÊ®ô
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleTap(int x, int y) {
        System.out.println("HomeScreen: Handling tap at (" + x + ", " + y + ")");
        
        // „Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíÂ§âÊèõ
        int[] coords = transformMouseCoordinates(x, y);
        int pageX = coords[0];
        int pageY = coords[1];
        int targetPageIndex = coords[2];
        
        // ÂØæË±°„Éö„Éº„Ç∏„ÅåÁØÑÂõ≤Â§ñ„ÅÆÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
        if (targetPageIndex < 0 || targetPageIndex >= homePages.size()) {
            return false;
        }
        
        HomePage targetPage = homePages.get(targetPageIndex);
        System.out.println("HomeScreen: Transformed tap to page " + targetPageIndex + " at (" + pageX + ", " + pageY + ")");
        
        // AppLibrary„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
        if (targetPage.isAppLibraryPage()) {
            return handleAppLibraryTap(pageX, pageY, targetPage);
        }
        
        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢Ôºà‰∏ãÈÉ®Ôºâ„ÅÆ„Çø„ÉÉ„Éó„ÅßApp Library„ÇíÈñã„ÅèÔºà„Ç≥„É≥„Éà„É≠„Éº„É´„Çª„É≥„Çø„ÉºÈ†òÂüü„ÇíÈô§„ÅèÔºâ
        if (pageY > (600 - NAV_AREA_HEIGHT) && pageY < 540) {
            openAppLibrary();
            return true;
        }
        
        // ÂØæË±°„Éö„Éº„Ç∏„ÅåÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        if (targetPageIndex != currentPageIndex && !isAnimating) {
            startPageTransition(targetPageIndex);
            return true;
        }
        
        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆ„Çø„ÉÉ„ÉóÂá¶ÁêÜÔºàÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„ÅÆ„ÅøÔºâ
        if (targetPageIndex == currentPageIndex) {
            Shortcut tappedShortcut = getShortcutAtPosition(pageX, pageY, targetPage);
            if (tappedShortcut != null) {
                if (isEditing) {
                    // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅØÂâäÈô§„Éú„Çø„É≥„Åã„Ç¢„Ç§„Ç≥„É≥„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (isClickingDeleteButton(pageX, pageY, tappedShortcut)) {
                        removeShortcut(tappedShortcut);
                    }
                } else {
                    // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åß„ÅØ„Ç¢„Éó„É™Ëµ∑ÂãïÔºà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„ÅçÔºâ
                    // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆÁîªÈù¢‰∏ä„Åß„ÅÆ‰ΩçÁΩÆ„ÇíË®àÁÆó
                    HomePage currentPage = homePages.get(targetPageIndex);
                    int startX = (400 - (GRID_COLS * (ICON_SIZE + ICON_SPACING) - ICON_SPACING)) / 2;
                    int startY = 80;
                    float iconX = startX + tappedShortcut.getGridX() * (ICON_SIZE + ICON_SPACING) + ICON_SIZE / 2;
                    float iconY = startY + tappedShortcut.getGridY() * (ICON_SIZE + ICON_SPACING + 20) + ICON_SIZE / 2;
                    launchApplicationWithAnimation(tappedShortcut.getApplication(), iconX, iconY, ICON_SIZE);
                }
                return true;
            }
        }
        
        // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Å´Á©∫„ÅÆ„Çπ„Éö„Éº„Çπ„Çí„Çø„ÉÉ„Éó„Åó„ÅüÂ†¥Âêà„ÅØÁ∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
        if (isEditing) {
            System.out.println("HomeScreen: Tapped empty space in edit mode - exiting edit mode");
            toggleEditMode();
            return true;
        }
        
        return false;
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Çø„ÉÉ„Éó„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param x XÂ∫ßÊ®ô
     * @param y YÂ∫ßÊ®ô
     * @param appLibraryPage AppLibrary„Éö„Éº„Ç∏
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleAppLibraryTap(int x, int y, HomePage appLibraryPage) {
        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢Ôºà‰∏ãÈÉ®Ôºâ„ÅÆ„Çø„ÉÉ„Éó„ÅØÁÑ°Ë¶ñ
        if (y > (600 - NAV_AREA_HEIGHT)) {
            return false;
        }
        
        // „Ç¢„Éó„É™„É™„Çπ„Éà„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        int startY = 110;
        int listHeight = 600 - startY - NAV_AREA_HEIGHT - 20;
        int itemHeight = 70;
        
        if (y >= startY && y <= startY + listHeight) {
            // „Çø„ÉÉ„Éó„Åï„Çå„Åü„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂèñÂæó
            IApplication tappedApp = appLibraryPage.getApplicationAtPosition(x, y, startY, itemHeight);
            if (tappedApp != null) {
                System.out.println("HomeScreen: AppLibrary„Åß„Ç¢„Éó„É™„Çí„Çø„ÉÉ„Éó: " + tappedApp.getName());
                // „Ç¢„Ç§„Ç≥„É≥‰ΩçÁΩÆ„ÇíË®àÁÆóÔºàAppLibrary„Ç¢„Ç§„ÉÜ„É†Áî®Ôºâ
                float iconX = 20 + 32; // ITEM_PADDING + ICON_SIZE/2
                float iconY = startY + ((y - startY) / itemHeight) * itemHeight + itemHeight / 2;
                launchApplicationWithAnimation(tappedApp, iconX, iconY, 32); // AppLibrary„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÅØ32
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * Èï∑Êäº„Åó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param x XÂ∫ßÊ®ô
     * @param y YÂ∫ßÊ®ô
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleLongPress(int x, int y) {
        System.out.println("HomeScreen: Handling long press at (" + x + ", " + y + ")");
        
        // „Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíÂ§âÊèõ
        int[] coords = transformMouseCoordinates(x, y);
        int pageX = coords[0];
        int pageY = coords[1];
        int targetPageIndex = coords[2];
        
        // ÂØæË±°„Éö„Éº„Ç∏„ÅåÁØÑÂõ≤Â§ñ„ÅÆÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
        if (targetPageIndex < 0 || targetPageIndex >= homePages.size()) {
            return false;
        }
        
        HomePage targetPage = homePages.get(targetPageIndex);
        
        // AppLibrary„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅÆÁâπÂà•Âá¶ÁêÜ
        if (targetPage.isAppLibraryPage()) {
            return handleAppLibraryLongPress(pageX, pageY, targetPage);
        }
        
        // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Åß„ÅÆÈï∑Êäº„Åó„ÅÆ„ÅøÁ∑®ÈõÜ„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        if (targetPageIndex == currentPageIndex && !isEditing) {
            toggleEditMode();
            return true;
        }
        
        return false;
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆÈï∑Êäº„Åó„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param x XÂ∫ßÊ®ô
     * @param y YÂ∫ßÊ®ô
     * @param appLibraryPage AppLibrary„Éö„Éº„Ç∏
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleAppLibraryLongPress(int x, int y, HomePage appLibraryPage) {
        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢Ôºà‰∏ãÈÉ®Ôºâ„ÅÆÈï∑Êäº„Åó„ÅØÁÑ°Ë¶ñ
        if (y > (600 - NAV_AREA_HEIGHT)) {
            return false;
        }
        
        // „Ç¢„Éó„É™„É™„Çπ„Éà„ÅÆÁØÑÂõ≤ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        int startY = 110;
        int listHeight = 600 - startY - NAV_AREA_HEIGHT - 20;
        int itemHeight = 70;
        
        if (y >= startY && y <= startY + listHeight) {
            // Èï∑Êäº„Åó„Åï„Çå„Åü„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂèñÂæó
            IApplication longPressedApp = appLibraryPage.getApplicationAtPosition(x, y, startY, itemHeight);
            if (longPressedApp != null) {
                System.out.println("HomeScreen: AppLibrary„ÅßÈï∑Êäº„Åó: " + longPressedApp.getName());
                showAddToHomePopup(longPressedApp, x, y);
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * „Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫„Åô„Çã„ÄÇ
     * 
     * @param app ÂØæË±°„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥
     * @param x „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫‰ΩçÁΩÆX
     * @param y „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫‰ΩçÁΩÆY
     */
    private void showAddToHomePopup(IApplication app, int x, int y) {
        if (kernel != null && kernel.getPopupManager() != null) {
            System.out.println("HomeScreen: ‚úÖ „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éû„Éç„Éº„Ç∏„É£„Éº„ÅåÂà©Áî®ÂèØËÉΩ");
            
            // Á∞°Âçò„Å™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê
            String message = "„Äå" + app.getName() + "„Äç„Çí„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü";
            
            // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Éû„Éç„Éº„Ç∏„É£„Éº„Å´ÂÆüË£Ö„Åï„Çå„Åü„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
            // ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„ÅØPopupManager„ÅÆ‰ªïÊßò„Å´‰æùÂ≠òÔºâ
            System.out.println("HomeScreen: üéØ „Äå„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Äç„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫‰∫àÂÆö");
            System.out.println("    ‚Ä¢ „Ç¢„Éó„É™Âêç: " + app.getName());
            System.out.println("    ‚Ä¢ ‰ΩçÁΩÆ: (" + x + ", " + y + ")");
            System.out.println("    ‚Ä¢ „É°„ÉÉ„Çª„Éº„Ç∏: " + message);
            
            // PopupManager„ÅÆÂÆüË£Ö„Å´Âøú„Åò„Å¶„Åì„Åì„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
            // ÁèæÂú®„ÅØ„É≠„Ç∞Âá∫Âäõ„ÅÆ„ÅøÔºàÂÆüÈöõ„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóÂÆüË£Ö„ÅØÂà•ÈÄîÂøÖË¶ÅÔºâ
        } else {
            System.err.println("HomeScreen: ‚ùå PopupManager„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì");
        }
    }
    
    /**
     * Â∑¶„Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleSwipeLeft() {
        // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„ÇÇ„Éö„Éº„Ç∏„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñÔºà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÁÑ°ÂäπÔºâ
        if (isEditing && isDragging) {
            System.out.println("HomeScreen: Left swipe ignored - dragging shortcut in edit mode");
            return false;
        }
        
        System.out.println("HomeScreen: Left swipe detected - next page");
        if (currentPageIndex < homePages.size() - 1) {
            startPageTransition(currentPageIndex + 1);
            return true;
        }
        return false;
    }
    
    /**
     * Âè≥„Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleSwipeRight() {
        // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„Åß„ÇÇ„Éö„Éº„Ç∏„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñÔºà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÁÑ°ÂäπÔºâ
        if (isEditing && isDragging) {
            System.out.println("HomeScreen: Right swipe ignored - dragging shortcut in edit mode");
            return false;
        }
        
        System.out.println("HomeScreen: Right swipe detected - previous page");
        if (currentPageIndex > 0) {
            startPageTransition(currentPageIndex - 1);
            return true;
        }
        return false;
    }
    
    /**
     * ‰∏ä„Çπ„ÉØ„Ç§„Éó„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleSwipeUp(GestureEvent event) {
        // ÁîªÈù¢‰∏ãÈÉ®ÔºàÈ´ò„Åï„ÅÆ90%‰ª•‰∏äÔºâ„Åã„Çâ„ÅÆ„Çπ„ÉØ„Ç§„Éó„Ç¢„ÉÉ„Éó„ÅØKernel„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´„Çª„É≥„Çø„ÉºÁî®„Å´‰∫àÁ¥Ñ
        if (event.getStartY() >= 600 * 0.9f) {
            System.out.println("HomeScreen: Bottom swipe up detected - letting Kernel handle control center");
            return false; // Kernel„Å´Âá¶ÁêÜ„ÇíÂßîË≠≤
        }
        
        // ÁîªÈù¢„ÅÆ‰∏≠Â§ÆÈÉ®„Åã„Çâ„ÅÆ„Çπ„ÉØ„Ç§„Éó„Ç¢„ÉÉ„Éó„ÅßApp Library„ÇíÈñã„Åè
        System.out.println("HomeScreen: Up swipe detected - opening integrated App Library");
        openAppLibrary();
        return true;
    }
    
    /**
     * „Éâ„É©„ÉÉ„Ç∞ÈñãÂßã„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleDragStart(GestureEvent event) {
        HomePage currentPage = getCurrentPage();
        if (currentPage != null && currentPage.isAppLibraryPage()) {
            // AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Éâ„É©„ÉÉ„Ç∞„ÅØ„Çπ„ÇØ„É≠„Éº„É´ÈñãÂßã
            return handleAppLibraryScrollStart(event);
        }
        
        // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÇíÂÑ™ÂÖàÁöÑ„Å´Âá¶ÁêÜ
        if (isEditing) {
            Shortcut clickedShortcut = getShortcutAtPositionWithTransform(event.getStartX(), event.getStartY());
            if (clickedShortcut != null) {
                // „Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÇíÈñãÂßã
                startDragging(clickedShortcut, event.getStartX(), event.getStartY());
                System.out.println("HomeScreen: Started icon drag for " + clickedShortcut.getDisplayName());
                return true; // „Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÅåÂÑ™ÂÖà„Åï„Çå„Çã
            }
        }
        
        return false; // „Éö„Éº„Ç∏„Çπ„ÉØ„Ç§„ÉóÁî®„ÅÆ„Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ„ÅØ handleDragMove „ÅßÂÆüË£Ö
    }
    
    /**
     * „Éâ„É©„ÉÉ„Ç∞ÁßªÂãï„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleDragMove(GestureEvent event) {
        HomePage currentPage = getCurrentPage();
        if (currentPage != null && currentPage.isAppLibraryPage()) {
            // AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Éâ„É©„ÉÉ„Ç∞„ÅØ„Çπ„ÇØ„É≠„Éº„É´
            return handleAppLibraryScroll(event);
        }
        
        // „Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÅåÈÄ≤Ë°å‰∏≠„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà
        if (isDragging && draggedShortcut != null) {
            int dragX = event.getCurrentX() - dragOffsetX;
            int dragY = event.getCurrentY() - dragOffsetY;

            // „Éâ„É©„ÉÉ„Ç∞Â∫ßÊ®ô„ÅÆÂ¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ„Å®Ë™øÊï¥
            dragX = constrainDragPosition(dragX, dragY)[0];
            dragY = constrainDragPosition(dragX, dragY)[1];

            draggedShortcut.setDragPosition(dragX, dragY);
            System.out.println("HomeScreen: Updating icon drag position to (" + dragX + ", " + dragY + ")");

            // ÁîªÈù¢Á´Ø„Åß„ÅÆËá™Âãï„Éö„Éº„Ç∏„Çπ„É©„Ç§„Éâ„ÇíÂÆüË£Ö
            handleEdgeAutoSlide(event.getCurrentX(), event.getCurrentY());

            return true; // „Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÅåÂÑ™ÂÖà
        }
        
        // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÇÇ„Éö„Éº„Ç∏„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñÔºà„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÁÑ°ÂäπÔºâ
        if (isEditing && isDragging) {
            return false; // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ„Éö„Éº„Ç∏„Éâ„É©„ÉÉ„Ç∞„ÇíÁÑ°Âäπ
        }

        // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åä„Çà„Å≥Á∑®ÈõÜ„É¢„Éº„ÉâÔºà„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠‰ª•Â§ñÔºâ„Åß„Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„Éâ„É©„ÉÉ„Ç∞„ÇíÂá¶ÁêÜ
        return handlePageDrag(event);
    }
    
    /**
     * „Éö„Éº„Ç∏„Éâ„É©„ÉÉ„Ç∞„ÇíÂá¶ÁêÜ„Åô„ÇãÔºà„É™„Ç¢„É´„Çø„Ç§„É†„Éö„Éº„Ç∏ÁßªÂãïÔºâ„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handlePageDrag(GestureEvent event) {
        if (isAnimating) {
            return false; // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅØ„Éâ„É©„ÉÉ„Ç∞„ÇíÁÑ°Ë¶ñ
        }
        
        int deltaX = event.getCurrentX() - event.getStartX();
        
        // Ê∞¥Âπ≥„Éâ„É©„ÉÉ„Ç∞„ÅÆ„Åø„Çí„Éö„Éº„Ç∏ÁßªÂãï„Å®„Åó„Å¶Êâ±„ÅÜ
        if (Math.abs(deltaX) > 10) { // 10px‰ª•‰∏ä„ÅÆ„Éâ„É©„ÉÉ„Ç∞„ÅßÂèçÂøú
            // „Éö„Éº„Ç∏„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË®àÁÆóÔºàÁîªÈù¢ÂπÖ„ÅÆÁØÑÂõ≤ÂÜÖ„ÅßÂà∂ÈôêÔºâ
            pageTransitionOffset = Math.max(-400, Math.min(400, deltaX));
            
            // Á´Ø„Éö„Éº„Ç∏„Åß„ÅÆÂà∂Èôê
            if (currentPageIndex == 0 && pageTransitionOffset > 0) {
                pageTransitionOffset *= 0.3f; // „Éê„Ç¶„É≥„ÇπÂäπÊûú
            } else if (currentPageIndex == homePages.size() - 1 && pageTransitionOffset < 0) {
                pageTransitionOffset *= 0.3f; // „Éê„Ç¶„É≥„ÇπÂäπÊûú
            }
            
            return true;
        }
        
        return false;
    }
    
    /**
     * „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleDragEnd(GestureEvent event) {
        HomePage currentPage = getCurrentPage();
        if (currentPage != null && currentPage.isAppLibraryPage()) {
            // AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„ÅØ„Çπ„ÇØ„É≠„Éº„É´ÁµÇ‰∫Ü
            return handleAppLibraryScrollEnd(event);
        }
        
        // „Ç¢„Ç§„Ç≥„É≥„Éâ„É©„ÉÉ„Ç∞„ÅÆÁµÇ‰∫ÜÂá¶ÁêÜ
        if (isDragging && draggedShortcut != null) {
            System.out.println("HomeScreen: Ending icon drag");
            handleShortcutDrop(event.getCurrentX(), event.getCurrentY());

            // ÁîªÈù¢Á´Ø„Çπ„É©„Ç§„ÉâÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            resetEdgeSlideState();

            return true;
        }
        
        // Á∑®ÈõÜ„É¢„Éº„Éâ„Åß„ÇÇ„Éö„Éº„Ç∏„Çπ„ÉØ„Ç§„Éó„ÇíÊúâÂäπÂåñÔºà„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØÁÑ°ÂäπÔºâ
        if (isEditing && isDragging) {
            return false; // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ„Éö„Éº„Ç∏„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„ÇíÁÑ°Âäπ
        }

        // ÈÄöÂ∏∏„É¢„Éº„Éâ„Åä„Çà„Å≥Á∑®ÈõÜ„É¢„Éº„ÉâÔºà„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Éâ„É©„ÉÉ„Ç∞‰∏≠‰ª•Â§ñÔºâ„Åß„Éö„Éº„Ç∏„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„ÇíÂá¶ÁêÜ
        return handlePageDragEnd(event);
    }
    
    /**
     * „Éö„Éº„Ç∏„Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫Ü„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handlePageDragEnd(GestureEvent event) {
        if (Math.abs(pageTransitionOffset) < 50) {
            // „Éâ„É©„ÉÉ„Ç∞Ë∑ùÈõ¢„ÅåÁü≠„ÅÑÂ†¥Âêà„ÅØÂÖÉ„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã
            startReturnToCurrentPage();
            return true;
        }
        
        // „Éâ„É©„ÉÉ„Ç∞Ë∑ùÈõ¢„ÅåÂçÅÂàÜ„Å™Â†¥Âêà„ÅØ„Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà
        if (pageTransitionOffset > 50 && currentPageIndex > 0) {
            // Âè≥„Å´„Éâ„É©„ÉÉ„Ç∞ - Ââç„ÅÆ„Éö„Éº„Ç∏
            startPageTransition(currentPageIndex - 1);
            return true;
        } else if (pageTransitionOffset < -50 && currentPageIndex < homePages.size() - 1) {
            // Â∑¶„Å´„Éâ„É©„ÉÉ„Ç∞ - Ê¨°„ÅÆ„Éö„Éº„Ç∏
            startPageTransition(currentPageIndex + 1);
            return true;
        } else {
            // Á´Ø„Éö„Éº„Ç∏„Åæ„Åü„ÅØÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åï„Å™„ÅÑÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Çã
            startReturnToCurrentPage();
            return true;
        }
    }
    
    /**
     * ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã„Åô„Çã„ÄÇ
     */
    private void startReturnToCurrentPage() {
        targetPageIndex = currentPageIndex;
        isAnimating = true;
        animationStartTime = System.currentTimeMillis();
        animationProgress = 0.0f;
        startOffset = pageTransitionOffset; // ÁèæÂú®„ÅÆ„Ç™„Éï„Çª„ÉÉ„Éà„Çí‰øùÂ≠ò
        animationBasePageIndex = currentPageIndex; // Â∫ßÊ®ôË®àÁÆó„ÅÆÂü∫Ê∫ñ„Éö„Éº„Ç∏„ÇíÂõ∫ÂÆö
        System.out.println("üé¨ Starting return animation to current page " + currentPageIndex + ", startOffset=" + startOffset + ", basePageIndex=" + animationBasePageIndex);
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÈñãÂßã„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleAppLibraryScrollStart(GestureEvent event) {
        System.out.println("HomeScreen: AppLibrary scroll started");
        return true; // „Çπ„ÇØ„É≠„Éº„É´ÈñãÂßã„ÇíÂèó„ÅëÂÖ•„Çå„Çã
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     * 
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleAppLibraryScroll(GestureEvent event) {
        HomePage currentPage = getCurrentPage();
        if (currentPage == null) return false;
        
        // ÂûÇÁõ¥„Éâ„É©„ÉÉ„Ç∞„ÅÆ„Åø„Çí„Çπ„ÇØ„É≠„Éº„É´„Å®„Åó„Å¶Êâ±„ÅÜ
        int deltaY = event.getCurrentY() - event.getStartY();
        
        // ÁèæÂú®„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„Ç™„Éï„Çª„ÉÉ„Éà„ÇíË™øÊï¥
        int currentScrollOffset = currentPage.getScrollOffset();
        int newScrollOffset = currentScrollOffset - deltaY; // ‰∏ãÊñπÂêë„Éâ„É©„ÉÉ„Ç∞„Åß‰∏äÊñπÂêë„Çπ„ÇØ„É≠„Éº„É´
        
        // „Çπ„ÇØ„É≠„Éº„É´ÁØÑÂõ≤„ÇíÂà∂Èôê
        int startY = 110;
        int listHeight = 600 - startY - NAV_AREA_HEIGHT - 20;
        int itemHeight = 70;
        List<IApplication> apps = currentPage.getAllApplications();
        int maxScrollOffset = Math.max(0, apps.size() * itemHeight - listHeight);
        
        newScrollOffset = Math.max(0, Math.min(maxScrollOffset, newScrollOffset));
        currentPage.setScrollOffset(newScrollOffset);
        
        System.out.println("HomeScreen: AppLibrary scrolled to offset " + newScrollOffset);
        return true;
    }
    
    /**
     * AppLibrary„Éö„Éº„Ç∏„Åß„ÅÆ„Çπ„ÇØ„É≠„Éº„É´ÁµÇ‰∫Ü„ÇíÂá¶ÁêÜ„Åô„Çã„ÄÇ
     *
     * @param event „Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
     * @return Âá¶ÁêÜ„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean handleAppLibraryScrollEnd(GestureEvent event) {
        System.out.println("HomeScreen: AppLibrary scroll ended");
        return true;
    }

    // Edge auto-slide functionality variables
    private long edgeSlideTimer = 0;
    private boolean isEdgeSliding = false;
    private static final int EDGE_SLIDE_ZONE = 30; // „Éî„ÇØ„Çª„É´Êï∞„Åß„ÅÆÁ´ØÊ§úÂá∫„Çæ„Éº„É≥
    private static final long EDGE_SLIDE_DELAY = 500; // „Éü„É™Áßí„Åß„ÅÆËá™Âãï„Çπ„É©„Ç§„ÉâÈÅÖÂª∂
    private static final int SCREEN_WIDTH = 400; // ÁîªÈù¢ÂπÖ (HomeScreen„ÅÆÊ®ôÊ∫ñÂπÖ)

    /**
     * „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅåÁîªÈù¢Á´Ø„Å´„ÅÇ„ÇãÂ†¥Âêà„ÄÅËá™ÂãïÁöÑ„Å´„Éö„Éº„Ç∏„Çπ„É©„Ç§„Éâ„ÇíÂÆüË°å„Åô„Çã„ÄÇ
     *
     * @param currentX ÁèæÂú®„ÅÆ„Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅ„ÅÆXÂ∫ßÊ®ô
     * @param currentY ÁèæÂú®„ÅÆ„Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅ„ÅÆYÂ∫ßÊ®ô
     */
    private void handleEdgeAutoSlide(int currentX, int currentY) {
        if (isAnimating) {
            return; // „Åô„Åß„Å´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        }

        // ÊúÄÂæå„ÅÆ„Éâ„É©„ÉÉ„Ç∞Â∫ßÊ®ô„ÇíË®òÈå≤ÔºàÁ∂ôÁ∂öÁöÑ„Å™„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
        lastDragX = currentX;
        lastDragY = currentY;

        long currentTime = System.currentTimeMillis();
        boolean inLeftEdge = currentX < EDGE_SLIDE_ZONE;
        boolean inRightEdge = currentX > (SCREEN_WIDTH - EDGE_SLIDE_ZONE);

        // ÁîªÈù¢Á´Ø„Å´ÂÖ•„Å£„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (inLeftEdge || inRightEdge) {
            if (!isEdgeSliding) {
                // ÂàùÂõû„ÅÆÁ´ØÊ§úÂá∫
                isEdgeSliding = true;
                edgeSlideTimer = currentTime;
                System.out.println("HomeScreen: [Move] Edge slide zone entered at X=" + currentX +
                                 (inLeftEdge ? " (LEFT)" : " (RIGHT)") + " - Timer started");
            } else {
                // Êó¢„Å´Á´Ø„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅØÁµåÈÅéÊôÇÈñì„ÇíË°®Á§∫
                long elapsed = currentTime - edgeSlideTimer;
                System.out.println("HomeScreen: [Move] Still in edge zone at X=" + currentX +
                                 " - Elapsed: " + elapsed + "ms / " + EDGE_SLIDE_DELAY + "ms");

                if (elapsed >= EDGE_SLIDE_DELAY) {
                    // ÂçÅÂàÜ„Å™ÊôÇÈñì„ÅåÁµåÈÅé„Åó„Åü„ÅÆ„ÅßËá™Âãï„Çπ„É©„Ç§„Éâ„ÇíÂÆüË°å
                    if (inLeftEdge && currentPageIndex > 0) {
                        // Â∑¶Á´Ø„Å™„ÅÆ„ÅßÂâç„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï
                        System.out.println("HomeScreen: [Move] Auto-sliding to previous page (LEFT edge)");
                        slideToPage(currentPageIndex - 1, true);
                        resetEdgeSlideState();
                    } else if (inRightEdge && currentPageIndex < homePages.size() - 1) {
                        // Âè≥Á´Ø„Å™„ÅÆ„ÅßÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï
                        System.out.println("HomeScreen: [Move] Auto-sliding to next page (RIGHT edge)");
                        slideToPage(currentPageIndex + 1, true);
                        resetEdgeSlideState();
                    } else {
                        // Á´Ø„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                        System.out.println("HomeScreen: [Move] Already at edge page, no auto-slide");
                        resetEdgeSlideState();
                    }
                }
            }
        } else {
            // ÁîªÈù¢Á´Ø„ÇíÈõ¢„Çå„Åü„ÅÆ„Åß„É™„Çª„ÉÉ„Éà
            if (isEdgeSliding) {
                System.out.println("HomeScreen: [Move] Left edge slide zone at X=" + currentX + " - Timer reset");
                resetEdgeSlideState();
            }
        }
    }

    /**
     * ÁîªÈù¢Á´Ø„Çπ„É©„Ç§„Éâ„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã„ÄÇ
     */
    private void resetEdgeSlideState() {
        isEdgeSliding = false;
        edgeSlideTimer = 0;
    }

    // ÊúÄÂæå„Å´Ë®òÈå≤„Åó„Åü„Éû„Ç¶„Çπ/„Çø„ÉÉ„ÉÅÂ∫ßÊ®ôÔºàÁ∂ôÁ∂öÁöÑ„Å™„Ç®„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
    private int lastDragX = 0;
    private int lastDragY = 0;

    // ÈÅÖÂª∂„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜÁî®„ÅÆÂ§âÊï∞
    private boolean hasPendingDrop = false;
    private int pendingDropX = 0;
    private int pendingDropY = 0;
    private Shortcut pendingDropShortcut = null;

    /**
     * ÊèèÁîª„É´„Éº„Éó‰∏≠„Å´„Ç®„ÉÉ„Ç∏Ëá™Âãï„Çπ„É©„Ç§„Éâ„ÅÆ„Çø„Ç§„Éû„Éº„ÇíÁ∂ôÁ∂öÁöÑ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åô„Çã„ÄÇ
     * „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅßÁîªÈù¢Á´Ø„Å´ÊªûÂú®„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÊôÇÈñìÁµåÈÅé„ÅßËá™Âãï„Çπ„É©„Ç§„Éâ„ÇíÂÆüË°å„Åô„Çã„ÄÇ
     */
    private void updateEdgeAutoSlideTimer() {
        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„Åã„Å§„Ç®„ÉÉ„Ç∏„Çπ„É©„Ç§„Éâ‰∏≠„ÅÆÂ†¥Âêà„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØ
        if (!isDragging || !isEdgeSliding || draggedShortcut == null || isAnimating) {
            return;
        }

        long currentTime = System.currentTimeMillis();
        boolean inLeftEdge = lastDragX < EDGE_SLIDE_ZONE;
        boolean inRightEdge = lastDragX > (SCREEN_WIDTH - EDGE_SLIDE_ZONE);

        // ÁîªÈù¢Á´Ø„Å´ÊªûÂú®„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÁ∂ôÁ∂ö„ÉÅ„Çß„ÉÉ„ÇØ
        if ((inLeftEdge || inRightEdge) && currentTime - edgeSlideTimer >= EDGE_SLIDE_DELAY) {
            System.out.println("HomeScreen: [Timer] Edge auto-slide triggered at X=" + lastDragX +
                             " after " + (currentTime - edgeSlideTimer) + "ms");

            if (inLeftEdge && currentPageIndex > 0) {
                // Â∑¶Á´Ø„Å™„ÅÆ„ÅßÂâç„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï
                System.out.println("HomeScreen: [Timer] Auto-sliding to previous page (LEFT edge)");
                slideToPage(currentPageIndex - 1, true);
                resetEdgeSlideState();
            } else if (inRightEdge && currentPageIndex < homePages.size() - 1) {
                // Âè≥Á´Ø„Å™„ÅÆ„ÅßÊ¨°„ÅÆ„Éö„Éº„Ç∏„Å´ÁßªÂãï
                System.out.println("HomeScreen: [Timer] Auto-sliding to next page (RIGHT edge)");
                slideToPage(currentPageIndex + 1, true);
                resetEdgeSlideState();
            } else {
                // Á´Ø„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
                System.out.println("HomeScreen: [Timer] Already at edge page, no auto-slide");
                resetEdgeSlideState();
            }
        }
    }

    /**
     * ÊåáÂÆö„Åó„Åü„Éö„Éº„Ç∏„Å´„Çπ„É©„Ç§„Éâ„Åô„Çã„ÄÇ
     * „Éâ„É©„ÉÉ„Ç∞Á∂ôÁ∂ö‰∏≠„Åß„ÇÇÂëº„Å≥Âá∫„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã„ÄÇ
     *
     * @param pageIndex ÁßªÂãïÂÖà„ÅÆ„Éö„Éº„Ç∏„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
     * @param maintainDrag „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„ÇíÁ∂≠ÊåÅ„Åô„Çã„Åã„Å©„ÅÜ„Åã
     */
    private void slideToPage(int pageIndex, boolean maintainDrag) {
        if (pageIndex < 0 || pageIndex >= homePages.size() || pageIndex == currentPageIndex) {
            return;
        }

        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅÆÊÉÖÂ†±„Çí‰øùÂ≠ò
        Shortcut savedDraggedShortcut = null;
        int savedDragOffsetX = 0, savedDragOffsetY = 0;
        boolean wasDragging = isDragging && draggedShortcut != null;

        if (wasDragging && maintainDrag) {
            savedDraggedShortcut = draggedShortcut;
            savedDragOffsetX = dragOffsetX;
            savedDragOffsetY = dragOffsetY;
            System.out.println("HomeScreen: Saving drag state for shortcut: " + savedDraggedShortcut.getDisplayName());
        }

        // „Éö„Éº„Ç∏Âàá„ÇäÊõø„Åà„ÇíÂÆüË°å
        currentPageIndex = pageIndex;
        targetPageIndex = pageIndex;
        isAnimating = true;
        animationStartTime = System.currentTimeMillis();
        animationProgress = 0.0f;
        pageTransitionOffset = 0.0f;
        startOffset = 0.0f;
        animationBasePageIndex = pageIndex;

        System.out.println("HomeScreen: Sliding to page " + pageIndex + " (maintainDrag=" + maintainDrag + ")");

        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
        if (wasDragging && maintainDrag && savedDraggedShortcut != null) {
            draggedShortcut = savedDraggedShortcut;
            dragOffsetX = savedDragOffsetX;
            dragOffsetY = savedDragOffsetY;
            isDragging = true;

            // „Éö„Éº„Ç∏Âàá„ÇäÊõø„ÅàÂæå„Å´„Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇíÁîªÈù¢ÂÜÖ„ÅÆÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´Ë™øÊï¥
            adjustDragPositionAfterSlide();

            System.out.println("HomeScreen: Restored drag state for shortcut: " + draggedShortcut.getDisplayName());
        }
    }

    /**
     * „Éö„Éº„Ç∏„Çπ„É©„Ç§„ÉâÂæå„ÅÆ„Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇíÁîªÈù¢ÂÜÖ„ÅÆÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´Ë™øÊï¥„Åô„Çã„ÄÇ
     * ÁîªÈù¢Á´Ø„Åß„Çπ„É©„Ç§„Éâ„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÄÅ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÁîªÈù¢ÂÜÖ„ÅÆÈÅ©Âàá„Å™‰ΩçÁΩÆ„Å´ÈÖçÁΩÆ„Åô„Çã„ÄÇ
     */
    private void adjustDragPositionAfterSlide() {
        if (draggedShortcut == null) {
            return;
        }

        // ÁèæÂú®„ÅÆ„Éâ„É©„ÉÉ„Ç∞‰ΩçÁΩÆ„ÇíÂèñÂæó
        float currentDragX = draggedShortcut.getDragX();
        float currentDragY = draggedShortcut.getDragY();

        // ÁîªÈù¢Â¢ÉÁïå
        final int MARGIN = 10; // ÁîªÈù¢Á´Ø„Åã„Çâ„ÅÆÂÆâÂÖ®„Éû„Éº„Ç∏„É≥
        final int MIN_X = MARGIN;
        final int MAX_X = SCREEN_WIDTH - ICON_SIZE - MARGIN;
        final int MIN_Y = 80; // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº‰∏ã
        final int MAX_Y = 600 - NAV_AREA_HEIGHT - ICON_SIZE - MARGIN; // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢‰∏ä

        float adjustedX = currentDragX;
        float adjustedY = currentDragY;

        // Â∑¶Á´Ø„Åã„Çâ„ÅÆ„Çπ„É©„Ç§„Éâ„ÅÆÂ†¥Âêà„ÄÅÂè≥ÂÅ¥„ÅÆÂÆâÂÖ®„Å™‰ΩçÁΩÆ„Å´ÁßªÂãï
        if (currentDragX < EDGE_SLIDE_ZONE) {
            adjustedX = EDGE_SLIDE_ZONE + 20; // Á´ØÊ§úÂá∫„Çæ„Éº„É≥„Åã„ÇâÂ∞ë„ÅóÂÜÖÂÅ¥
            System.out.println("HomeScreen: Adjusting drag X from " + currentDragX + " to " + adjustedX + " (left edge slide)");
        }
        // Âè≥Á´Ø„Åã„Çâ„ÅÆ„Çπ„É©„Ç§„Éâ„ÅÆÂ†¥Âêà„ÄÅÂ∑¶ÂÅ¥„ÅÆÂÆâÂÖ®„Å™‰ΩçÁΩÆ„Å´ÁßªÂãï
        else if (currentDragX > (SCREEN_WIDTH - EDGE_SLIDE_ZONE)) {
            adjustedX = SCREEN_WIDTH - EDGE_SLIDE_ZONE - 20; // Á´ØÊ§úÂá∫„Çæ„Éº„É≥„Åã„ÇâÂ∞ë„ÅóÂÜÖÂÅ¥
            System.out.println("HomeScreen: Adjusting drag X from " + currentDragX + " to " + adjustedX + " (right edge slide)");
        }

        // YÂ∫ßÊ®ô„ÅÆÂ¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
        if (adjustedY < MIN_Y) {
            adjustedY = MIN_Y;
            System.out.println("HomeScreen: Adjusting drag Y from " + currentDragY + " to " + adjustedY + " (top boundary)");
        } else if (adjustedY > MAX_Y) {
            adjustedY = MAX_Y;
            System.out.println("HomeScreen: Adjusting drag Y from " + currentDragY + " to " + adjustedY + " (bottom boundary)");
        }

        // XÂ∫ßÊ®ô„ÅÆÊúÄÁµÇÂ¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
        if (adjustedX < MIN_X) {
            adjustedX = MIN_X;
            System.out.println("HomeScreen: Final X adjustment from " + currentDragX + " to " + adjustedX + " (left boundary)");
        } else if (adjustedX > MAX_X) {
            adjustedX = MAX_X;
            System.out.println("HomeScreen: Final X adjustment from " + currentDragX + " to " + adjustedX + " (right boundary)");
        }

        // Ë™øÊï¥„Åï„Çå„ÅüÂ∫ßÊ®ô„ÇíË®≠ÂÆö
        draggedShortcut.setDragPosition((int)adjustedX, (int)adjustedY);

        // lastDragX/Y„ÇÇÊõ¥Êñ∞ÔºàÁ∂ôÁ∂öÁöÑ„Å™„Ç®„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØÁî®Ôºâ
        lastDragX = (int)adjustedX;
        lastDragY = (int)adjustedY;

        System.out.println("HomeScreen: Drag position adjusted to (" + (int)adjustedX + ", " + (int)adjustedY + ")");
    }

    /**
     * „Éâ„É©„ÉÉ„Ç∞Â∫ßÊ®ô„ÇíÁîªÈù¢Â¢ÉÁïåÂÜÖ„Å´Âà∂Èôê„Åô„Çã„ÄÇ
     *
     * @param dragX ÂÖÉ„ÅÆ„Éâ„É©„ÉÉ„Ç∞XÂ∫ßÊ®ô
     * @param dragY ÂÖÉ„ÅÆ„Éâ„É©„ÉÉ„Ç∞YÂ∫ßÊ®ô
     * @return Âà∂ÈôêÂæå„ÅÆÂ∫ßÊ®ô [adjustedX, adjustedY]
     */
    private int[] constrainDragPosition(int dragX, int dragY) {
        // ÁîªÈù¢Â¢ÉÁïåÔºàÈÄöÂ∏∏„ÅÆ„Éâ„É©„ÉÉ„Ç∞Áî®Ôºâ
        final int MIN_X = -10; // Â∞ë„ÅóÁîªÈù¢Â§ñ„Åæ„ÅßË®±ÂèØÔºà„Ç®„ÉÉ„Ç∏Ê§úÂá∫„ÅÆ„Åü„ÇÅÔºâ
        final int MAX_X = SCREEN_WIDTH + 10; // Â∞ë„ÅóÁîªÈù¢Â§ñ„Åæ„ÅßË®±ÂèØÔºà„Ç®„ÉÉ„Ç∏Ê§úÂá∫„ÅÆ„Åü„ÇÅÔºâ
        final int MIN_Y = 80; // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº‰∏ã
        final int MAX_Y = 600 - NAV_AREA_HEIGHT - 10; // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç®„É™„Ç¢‰∏ä

        int adjustedX = Math.max(MIN_X, Math.min(MAX_X, dragX));
        int adjustedY = Math.max(MIN_Y, Math.min(MAX_Y, dragY));

        return new int[]{adjustedX, adjustedY};
    }

    /**
     * ÂÖ®„Éö„Éº„Ç∏„Åã„Çâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÂâäÈô§„Åô„ÇãÔºà„Éö„Éº„Ç∏ÈñìÁßªÂãïÊôÇ„ÅÆÈáçË§áÈò≤Ê≠¢Ôºâ„ÄÇ
     *
     * @param shortcut ÂâäÈô§„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
     */
    private void removeShortcutFromAllPages(Shortcut shortcut) {
        if (shortcut == null) return;

        System.out.println("HomeScreen: [REMOVE] Removing shortcut '" + shortcut.getDisplayName() + "' from all pages");

        for (int i = 0; i < homePages.size(); i++) {
            HomePage page = homePages.get(i);
            boolean removed = page.removeShortcut(shortcut);
            if (removed) {
                System.out.println("HomeScreen: [REMOVE] Removed from page " + i);
            }
        }
    }

    /**
     * „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰∏≠„Å´„Éâ„É≠„ÉÉ„Éó„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÄÅ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÂÆüË°å„Åô„Çã„Çà„ÅÜ„Çπ„Ç±„Ç∏„É•„Éº„É´„Åô„Çã„ÄÇ
     *
     * @param mouseX „Éâ„É≠„ÉÉ„Éó„ÅÆXÂ∫ßÊ®ô
     * @param mouseY „Éâ„É≠„ÉÉ„Éó„ÅÆYÂ∫ßÊ®ô
     */
    private void scheduleDelayedDrop(int mouseX, int mouseY) {
        hasPendingDrop = true;
        pendingDropX = mouseX;
        pendingDropY = mouseY;
        pendingDropShortcut = draggedShortcut;

        System.out.println("HomeScreen: [DROP] Scheduled delayed drop for shortcut '" +
                          (pendingDropShortcut != null ? pendingDropShortcut.getDisplayName() : "null") +
                          "' at (" + mouseX + ", " + mouseY + ")");

        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„Çí„ÅÑ„Å£„Åü„Çì„ÇØ„É™„Ç¢Ôºà„Åü„Å†„Åó„ÄÅÈÅÖÂª∂„Éâ„É≠„ÉÉ„Éó„ÅÆ„Åü„ÇÅ„Å´„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÊÉÖÂ†±„ÅØ‰øùÊåÅÔºâ
        isDragging = false;
    }

    /**
     * „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´ÈÅÖÂª∂„Åï„Çå„Åü„Éâ„É≠„ÉÉ„Éó„ÇíÂÆüË°å„Åô„Çã„ÄÇ
     */
    private void executePendingDrop() {
        if (hasPendingDrop && pendingDropShortcut != null) {
            System.out.println("HomeScreen: [DROP] Executing pending drop for shortcut '" +
                              pendingDropShortcut.getDisplayName() + "' at (" + pendingDropX + ", " + pendingDropY + ")");

            // ÈÅÖÂª∂„Éâ„É≠„ÉÉ„Éó„ÅÆÂÆüË°å
            executeDrop(pendingDropX, pendingDropY, pendingDropShortcut);

            // ÈÅÖÂª∂„Éâ„É≠„ÉÉ„ÉóÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            hasPendingDrop = false;
            pendingDropX = 0;
            pendingDropY = 0;
            pendingDropShortcut = null;
        }
    }

    /**
     * ÂÆüÈöõ„ÅÆ„Éâ„É≠„ÉÉ„ÉóÂá¶ÁêÜ„ÇíÂÆüË°å„Åô„ÇãÔºàÂç≥Â∫ßÂÆüË°å„Å®ÈÅÖÂª∂ÂÆüË°å„ÅßÂÖ±ÈÄöÔºâ„ÄÇ
     *
     * @param mouseX „Éâ„É≠„ÉÉ„Éó„ÅÆXÂ∫ßÊ®ô
     * @param mouseY „Éâ„É≠„ÉÉ„Éó„ÅÆYÂ∫ßÊ®ô
     * @param shortcut „Éâ„É≠„ÉÉ„Éó„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
     */
    private void executeDrop(int mouseX, int mouseY, Shortcut shortcut) {
        if (shortcut == null) return;

        System.out.println("HomeScreen: [EXECUTE] Executing drop for shortcut '" + shortcut.getDisplayName() +
                          "' at (" + mouseX + ", " + mouseY + ") on page " + currentPageIndex);

        // Calculate target grid position
        int[] gridPos = screenToGridPosition(mouseX, mouseY);
        if (gridPos != null) {
            HomePage targetPage = getCurrentPage();
            if (targetPage != null) {
                System.out.println("HomeScreen: [EXECUTE] Target page: " + currentPageIndex + ", Grid position: (" + gridPos[0] + ", " + gridPos[1] + ")");

                // ÂÆâÂÖ®„Å™ÈÖçÁΩÆÂá¶ÁêÜÔºöÂÖà„Å´ÈÖçÁΩÆ„ÇíË©¶Ë°å„Åó„ÄÅÊàêÂäü„Åó„ÅüÂ†¥Âêà„ÅÆ„Åø‰ªñ„ÅÆ„Éö„Éº„Ç∏„Åã„ÇâÂâäÈô§
                boolean placed = safelyPlaceShortcut(shortcut, targetPage, gridPos[0], gridPos[1]);

                if (placed) {
                    System.out.println("HomeScreen: [EXECUTE] „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà '" + shortcut.getDisplayName() +
                                     "' „Çí„Éö„Éº„Ç∏ " + currentPageIndex + " „ÅÆ (" + gridPos[0] + ", " + gridPos[1] + ") „Å´ÈÖçÁΩÆ„Åó„Åæ„Åó„Åü");
                    saveCurrentLayout();
                } else {
                    System.out.println("HomeScreen: [EXECUTE] „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÈÖçÁΩÆÂ§±Êïó - „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÂÆüË°å");

                    // ÈÖçÁΩÆÂ§±ÊïóÊôÇ„ÅØÊúÄÂàù„ÅÆÁ©∫„Åç„Çπ„É≠„ÉÉ„Éà„Å´ÈÖçÁΩÆ
                    int[] emptySlot = findFirstEmptySlot(targetPage);
                    if (emptySlot != null && safelyPlaceShortcut(shortcut, targetPage, emptySlot[0], emptySlot[1])) {
                        System.out.println("HomeScreen: [EXECUTE] „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Á©∫„Åç„Çπ„É≠„ÉÉ„Éà (" + emptySlot[0] + ", " + emptySlot[1] + ") „Å´ÈÖçÁΩÆ„Åó„Åæ„Åó„Åü");
                        saveCurrentLayout();
                    } else {
                        System.out.println("HomeScreen: [EXECUTE] „Ç®„É©„Éº: ÈÖçÁΩÆÂèØËÉΩ„Å™Á©∫„Åç„Çπ„É≠„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì - „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÂÖÉ„ÅÆÂ†¥ÊâÄ„Å´Êàª„Åó„Åæ„Åô");
                        // ÊúÄÊÇ™„ÅÆÂ†¥Âêà„ÅØÂÖÉ„ÅÆÂ†¥ÊâÄ„Å´Êàª„ÅôÔºàÂâäÈô§„ÇíÈò≤„ÅêÔºâ
                        restoreShortcutToSafePage(shortcut);
                    }
                }
            }
        }

        // Reset drag state
        resetDragState();
    }

    /**
     * „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÂÆâÂÖ®„Å´ÈÖçÁΩÆ„Åô„Çã„ÄÇ
     * ‰ªñ„ÅÆ„Éö„Éº„Ç∏„Åã„ÇâÂâäÈô§„Åô„ÇãÂâç„Å´„ÄÅ„Åæ„ÅöÁõÆÊ®ô„Éö„Éº„Ç∏„Å´ÈÖçÁΩÆ„Åß„Åç„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã„ÄÇ
     *
     * @param shortcut ÈÖçÁΩÆ„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
     * @param targetPage ÁõÆÊ®ô„Éö„Éº„Ç∏
     * @param gridX ÁõÆÊ®ô„Ç∞„É™„ÉÉ„ÉâXÂ∫ßÊ®ô
     * @param gridY ÁõÆÊ®ô„Ç∞„É™„ÉÉ„ÉâYÂ∫ßÊ®ô
     * @return ÈÖçÁΩÆ„Å´ÊàêÂäü„Åó„ÅüÂ†¥Âêàtrue
     */
    private boolean safelyPlaceShortcut(Shortcut shortcut, HomePage targetPage, int gridX, int gridY) {
        if (shortcut == null || targetPage == null) {
            return false;
        }

        System.out.println("HomeScreen: [SAFE_PLACE] Attempting to place shortcut '" + shortcut.getDisplayName() +
                          "' at (" + gridX + ", " + gridY + ") on page " + currentPageIndex);

        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅåÊó¢„Å´„Çø„Éº„Ç≤„ÉÉ„Éà„Éö„Éº„Ç∏„Å´„ÅÇ„ÇãÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆmoveShortcut„Çí‰ΩøÁî®
        if (targetPage.getShortcuts().contains(shortcut)) {
            System.out.println("HomeScreen: [SAFE_PLACE] Shortcut already on target page, using moveShortcut");
            return targetPage.moveShortcut(shortcut, gridX, gridY);
        }

        // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Åå‰ªñ„ÅÆ„Éö„Éº„Ç∏„Å´„ÅÇ„ÇãÂ†¥Âêà
        // 1. „Åæ„Åö„ÄÅÁõÆÊ®ô‰ΩçÁΩÆ„ÅåÁ©∫„ÅÑ„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (!targetPage.isPositionEmpty(gridX, gridY)) {
            System.out.println("HomeScreen: [SAFE_PLACE] Target position is occupied");
            return false;
        }

        // 2. ‰ªñ„ÅÆ„Éö„Éº„Ç∏„Åã„ÇâÂâäÈô§
        HomePage sourcePageFound = null;
        for (HomePage page : homePages) {
            if (page.getShortcuts().contains(shortcut)) {
                sourcePageFound = page;
                break;
            }
        }

        if (sourcePageFound != null) {
            System.out.println("HomeScreen: [SAFE_PLACE] Removing shortcut from source page");
            boolean removed = sourcePageFound.removeShortcut(shortcut);
            if (!removed) {
                System.out.println("HomeScreen: [SAFE_PLACE] Failed to remove from source page");
                return false;
            }
        }

        // 3. „Çø„Éº„Ç≤„ÉÉ„Éà„Éö„Éº„Ç∏„Å´ËøΩÂä†
        boolean added = targetPage.addShortcut(shortcut, gridX, gridY);
        if (!added) {
            System.out.println("HomeScreen: [SAFE_PLACE] Failed to add to target page - restoring to source page");
            // ËøΩÂä†„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„ÅÆ„Éö„Éº„Ç∏„Å´Êàª„Åô
            if (sourcePageFound != null) {
                int[] emptySlot = findFirstEmptySlot(sourcePageFound);
                if (emptySlot != null) {
                    sourcePageFound.addShortcut(shortcut, emptySlot[0], emptySlot[1]);
                    System.out.println("HomeScreen: [SAFE_PLACE] Restored shortcut to source page at (" + emptySlot[0] + ", " + emptySlot[1] + ")");
                }
            }
            return false;
        }

        System.out.println("HomeScreen: [SAFE_PLACE] Successfully placed shortcut at (" + gridX + ", " + gridY + ")");
        return true;
    }

    /**
     * „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÇíÂÆâÂÖ®„Å™Â†¥ÊâÄ„Å´Âæ©ÂÖÉ„Åô„ÇãÔºàÈÖçÁΩÆÂ§±ÊïóÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ„ÄÇ
     *
     * @param shortcut Âæ©ÂÖÉ„Åô„Çã„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
     */
    private void restoreShortcutToSafePage(Shortcut shortcut) {
        if (shortcut == null) return;

        System.out.println("HomeScreen: [RESTORE] Restoring shortcut '" + shortcut.getDisplayName() + "' to safe page");

        // ÊúÄÂàù„ÅÆ„Éö„Éº„Ç∏„ÅßÁ©∫„Åç„Çπ„É≠„ÉÉ„Éà„ÇíÊé¢„Åô
        for (HomePage page : homePages) {
            if (page.isAppLibraryPage()) continue; // AppLibrary„Éö„Éº„Ç∏„ÅØ„Çπ„Ç≠„ÉÉ„Éó

            int[] emptySlot = findFirstEmptySlot(page);
            if (emptySlot != null) {
                boolean added = page.addShortcut(shortcut, emptySlot[0], emptySlot[1]);
                if (added) {
                    System.out.println("HomeScreen: [RESTORE] Restored shortcut to page at (" + emptySlot[0] + ", " + emptySlot[1] + ")");
                    return;
                }
            }
        }

        System.out.println("HomeScreen: [RESTORE] Warning: Could not find safe page for shortcut");
    }
}
