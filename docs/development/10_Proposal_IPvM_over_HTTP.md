# 仮想インターネット・アーキテクチャ刷新提案書: IPvM over HTTP

**作成日**: 2025年12月14日
**ステータス**: 提案中 (Proposed)
**対象**: Project MochiMobileOS Development Team (Claude Code / CodeX)

## 1. 概要
現在の仮想インターネット実装における独自スキーム `httpm://` を廃止し、標準の `http://` プロトコル上で仮想IPアドレス (`IPvM`) を解釈・ルーティングする方式へ移行することを提案します。これにより、実装の冗長性を排除し、現実のTCP/IP階層モデルに近い、教育的価値の高いアーキテクチャを実現します。

## 2. 背景と課題

### 2.1. 現状のアーキテクチャ
現在、MochiMobileOS内の仮想ネットワーク上のWebサーバーにアクセスするために、`httpm://[IPvM-Address]/path` という独自のURIスキームを使用しています。これには専用の `CefSchemeHandler` 実装が必要です。

### 2.2. 課題
1.  **実装の複雑さと冗長性**: 独自スキームをブラウザに認識させるために、JCEFの深部（SchemeHandlerFactory等）に手を入れる必要があり、保守コストが高い。また、HTTPとほぼ同じ挙動をするプロトコルを再実装している点が冗長である。
2.  **教育的観点からの不正確さ**: 「新しいネットワークに接続するには、新しいURIスキーム（プロトコル）が必要である」という誤ったメンタルモデルを学習者に与えかねない。本来、HTTP（アプリケーション層）は下位のネットワーク層（IPv4/IPv6/IPvM）が何であるかに関知すべきではない。
3.  **拡張性の欠如**: 今後、FTP等の他プロトコルを仮想ネットワーク対応させる際、同様の独自スキーム実装が必要になってしまう。

## 3. 提案: IPvM over HTTP (http://[IPvM])

### 3.1. コンセプト
独自スキーム `httpm` を廃止し、標準の `http://` (および `https://`) スキームを使用します。
ブラウザからのリクエスト送信時に**ホスト名（ドメイン部分）を解析**し、それがIPvMアドレス形式であれば仮想ネットワークへ、そうでなければ外部インターネットへルーティングします。

*   **旧**: `httpm://3-sys-google/index.html`
*   **新**: `http://3-sys-google/index.html`

### 3.2. アーキテクチャ変更点
OSI参照モデルを模した以下の階層構造へ移行します。

1.  **アプリケーション層 (HTTP)**: ブラウザは通常のHTTPリクエストとして処理を開始。
2.  **トランスポート/ネットワーク層 (Interceptor)**:
    *   システム（Mod）がリクエストをインターセプト。
    *   宛先ホストが `IPvM` パターン（例: `0-uuid`, `3-id`）に一致するか判定。
    *   **一致する場合**: 外部通信を遮断し、`VirtualRouter` 経由で仮想パケットを送信。
    *   **一致しない場合**: 通常通り外部インターネット（物理NIC）へ流す。

### 3.3. メリット
1.  **教育的価値の向上**: 「アプリケーション層（HTTP）はそのままで、ネットワーク層のルーティングによって通信先が変わる」というインターネットの仕組みを正しくシミュレートできる。
2.  **コードの簡素化**: 独自スキーム登録に関するボイラープレートコード（`ChromiumAppHandler`内の登録処理など）を全廃できる。
3.  **互換性**: 標準的なURL形式となるため、既存のWeb技術やライブラリとの親和性が高まる。

## 4. 実装計画

### Phase 1: `httpm` の廃止とクリーンアップ
*   `HttpmSchemeHandler` および `HttpmSchemeHandlerFactory` の削除。
*   `ChromiumAppHandler` から `httpm` スキーム登録処理を削除。
*   `CoreServiceBootstrap` から関連する初期化コードを削除。

### Phase 2: リクエストインターセプターの実装
*   **`VirtualNetworkInterceptor` の作成**:
    *   JCEFの `CefRequestHandler` (または `CefResourceRequestHandler`) を実装。
    *   `onBeforeResourceLoad` または `getResourceHandler` メソッドでURLを検査。
*   **ホスト名判定ロジック**:
    *   正規表現 `^[0-3]-[0-9a-fA-F-]+$` 等を用いてIPvMアドレスを検出。
*   **`VirtualNetworkResourceHandler` の実装**:
    *   旧 `HttpmSchemeHandler` のロジックを流用し、`VirtualRouter` とパケット送受信を行うハンドラーを作成。
    *   HTTPレスポンスを生成してブラウザに返す。

### Phase 3: 統合とテスト
*   **URLの書き換え**: デモアプリやドキュメント内の `httpm://` を `http://` に置換。
*   **動作検証**:
    *   `http://3-sys-google` → 仮想ネットワーク経由で表示されること。
    *   `http://google.com` → 外部インターネット経由で表示されること。

## 5. 結論
本提案は、MochiMobileOSの「教育用OSシミュレーター」としての質を高め、かつコードベースを健全化するための重要なリファクタリングです。この方針での実装を推奨します。
