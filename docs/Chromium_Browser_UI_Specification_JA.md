# MochiMobileOS Chromiumブラウザ UI/UX仕様書

**バージョン:** 1.0
**日付:** 2025年10月21日
**ステータス:** 最終版

## 1. はじめに

### 1.1. 目的
このドキュメントは、MochiMobileOSに搭載される新しいChromiumベースのウェブブラウザに関するユーザーインターフェース（UI）およびユーザーエクスペリエンス（UX）の仕様を定義するものです。開発担当チーム（CodeX）向けの公式ガイドとして機能します。

### 1.2. 設計思想
モダンでクリーン、かつ直感的なインターフェースの実現を目指し、以下の項目を優先します:
- **一貫性:** 既存のMochiMobileOSのデザイン言語とコンポーネントライブラリへの準拠。
- **パフォーマンス:** 特にForge環境における低リソース消費。
- **操作性:** 現代のモバイルブラウザに慣れたユーザーにとって直感的なレイアウト。

---

## 2. 全体設計

### 2.1. レイアウト
画面は主に3つのエリアに分割されます:

```
+--------------------------------------+
| (A) 上部アドレスバー (高さ: 50px)      |
+--------------------------------------+
|                                      |
| (B) コンテンツエリア (高さ: 500px)     |
|      (ウェブページ表示領域)            |
|                                      |
+--------------------------------------+
| (C) 下部ナビゲーションバー (高さ: 50px) |
+--------------------------------------+
```

### 2.2. カラースキーム
UIはシステムのライトテーマおよびダークテーマに適応する必要があります。一貫性を保証するため、すべての色は `Theme.java` に定義された定数を参照してください。

| 要素 | ライトテーマ (例) | ダークテーマ (例) | `Theme.java` 定数 (想定) |
| :--- | :--- | :--- | :--- |
| **アプリ背景** | `#F8F9FA` (オフホワイト) | `#121212` (ほぼ黒) | `Theme.APP_BACKGROUND` |
| **バー/カード背景** | `#FFFFFF` (白) | `#1E1E1E` (ダークグレー) | `Theme.SURFACE_BACKGROUND` |
| **主要テキスト/アイコン** | `#202124` (濃いグレー) | `#E8EAED` (オフホワイト) | `Theme.TEXT_PRIMARY` |
| **補助テキスト** | `#5F6368` (ミディアムグレー) | `#9AA0A6` (ライトグレー) | `Theme.TEXT_SECONDARY` |
| **アクセントカラー** | `#1A73E8` (Google Blue) | `#8AB4F8` (ライトブルー) | `Theme.ACCENT_COLOR` |
| **無効化要素** | `#BDC1C6` (ライトグレー) | `#5F6368` (ダークグレー) | `Theme.DISABLED_COLOR` |
| **境界線** | `#E0E2E6` (非常に薄いグレー) | `#3C4043` (濃いグレー) | `Theme.DIVIDER_COLOR` |

### 2.3. タイポグラフィ
- **フォント:** `Noto Sans JP` (`Kernel.getJapaneseFont()` 経由で取得)
- **URLテキスト:** 14px, Regular
- **メニュー項目:** 16px, Medium

### 2.4. アイコン
- **ライブラリ:** Material Design Icons
- **フォーマット:** SVG
- **配置場所:** `core/src/main/resources/icons/`
- **実装:** `ImageView` コンポーネントを使用して描画

---

## 3. コンポーネント詳細仕様

### 3.1. (A) 上部アドレスバー
**目的:** 現在のページの情報を表示し、ページ固有のアクションを実行する。

**レイアウト:**
```
| [🔒 example.com/path/to/page... ] | ✰ | ⟳ |
```

**コンポーネント:**
1.  **アドレス表示エリア:**
    - **コンポーネント:** `Panel` またはカスタムコンポーネント
    - **スタイル:**
        - 背景: `Theme.APP_BACKGROUND`
        - 角丸半径: `25px`
    - **インタラクション:**
        - タップでURL入力用の `TextField` に切り替わる。
        - ページ読み込み中、下辺に高さ `2px` の `ProgressBar` (色: `Theme.ACCENT_COLOR`) を表示する。

2.  **ブックマークボタン:**
    - **コンポーネント:** `Button`
    - **アイコン:** `star_outline` (デフォルト), `star` (ブックマーク済みの場合)
    - **アクション:** 現在のページのブックマーク状態を切り替える。

3.  **再読み込み/停止ボタン:**
    - **コンポーネント:** `Button`
    - **アイコン:** `refresh` (デフォルト), `close` (読み込み中の場合)
    - **アクション:** ページを再読み込み、または読み込みを停止する。

### 3.2. (C) 下部ナビゲーションバー
**目的:** 主要なブラウザナビゲーションと機能へのアクセスを提供する。

**レイアウト:**
```
|  [◀]  |  [▶]  |  [➕]  |  [□]  |  [...]  |
```

**コンポーネント:**
1.  **戻るボタン:**
    - **アイコン:** `arrow_back`
    - **アクション:** `browser.goBack()`
    - **状態:** `browser.canGoBack()` が `false` の場合、無効化 (色: `Theme.DISABLED_COLOR`) する。

2.  **進むボタン:**
    - **アイコン:** `arrow_forward`
    - **アクション:** `browser.goForward()`
    - **状態:** `browser.canGoForward()` が `false` の場合、無効化する。

3.  **新規タブボタン:**
    - **コンポーネント:** `Panel` と中央に配置した `ImageView`
    - **スタイル:**
        - 形状: 直径 `36px` の円形
        - 背景: `Theme.ACCENT_COLOR`
        - アイコン色: `Theme.SURFACE_BACKGROUND`
    - **アイコン:** `add`
    - **アクション:** 新しいタブを作成し、そのタブに切り替える。

4.  **タブ一覧ボタン:**
    - **アイコン:** `check_box_outline_blank`。オプションで、開いているタブ数をアイコン内に表示してもよい。
    - **アクション:** 「タブ一覧画面」に遷移する。

5.  **その他オプションボタン:**
    - **アイコン:** `more_horiz`
    - **アクション:** 「その他オプションメニュー」を表示する。

### 3.3. 全般的なインタラクション
- **タップエフェクト:** 上下バーのすべてのアイコンボタンは、タップ時にリップルエフェクト（さざ波のようなエフェクト）を適用する (色: `Theme.ACCENT_COLOR` の透明度15%版, 直径: 40px)。

---

## 4. 画面別仕様

### 4.1. タブ一覧画面
- **レイアウト:** `GridLayout` (2列) を使用したタブカードの一覧。
- **カードのスタイル:**
    - **コンポーネント:** `Panel`
    - **背景:** `Theme.SURFACE_BACKGROUND`
    - **角丸半径:** `12px`
    - **影:** わずかなドロップシャドウを適用 (`color: #000000`, `opacity: 0.1`, `y-offset: 2px`, `blur: 4px`)。
- **カードの内容:**
    - ページのサムネイルを表示する `ImageView`
    - ページタイトルを表示する `Label`
    - 右上に配置された円形の「閉じる」(`close`) `Button`
- **インタラクション:**
    - カードのタップで該当タブに切り替わる。
    - 「閉じる」ボタンのタップでタブを閉じる。
- **現行実装メモ:** 2025-10-21 時点ではフル画面のカードリストオーバーレイを暫定実装（タブ名/URL表示・タップ切替・外側タップで閉じる）。サムネイルやスワイプ削除は今後追加予定。

### 4.2. その他オプションメニュー
- **レイアウト:** 画面下から表示されるボトムシート形式の `Dialog`。
- **アニメーション:** `0.3秒`かけて画面下からスライドイン (`ease-out` カーブ)。
- **スタイル:**
    - **背景:** `Theme.SURFACE_BACKGROUND`
    - **角丸半径:** 上辺の左右のみ `16px`。
- **内容:** アクションの `ListView`。各項目はアイコンとラベルで構成。
    - `[⭐] ブックマーク`
    - `[🕒] 履歴`
    - `[💻] PC版サイト`
    - `[⚙️] 設定`
- **現行実装メモ:** 2025-10-21 時点の実装では「再読み込み」「タブを閉じる」「他のタブを閉じる」を提供。将来的にブックマーク/履歴/デスクトップサイト切替を追加予定。

---

## 5. データ構造 (VFS向け)

### 5.1. ブックマーク
- **ファイル:** `system/browser_chromium/bookmarks.json`
- **フォーマット:**
```json
[
  {
    "title": "Google",
    "url": "https://www.google.com",
    "favicon_url": "https://www.google.com/favicon.ico",
    "timestamp": 1666300000000
  }
]
```

### 5.2. 履歴
- **ファイル:** `system/browser_chromium/history.json`
- **フォーマット:**
```json
[
  {
    "title": "MochiMobileOS 開発ガイド",
    "url": "httpm://internal-docs/DEV.md",
    "timestamp": 1666300800000
  }
]
```

---

## 6. 実装者 (CodeX) への注記
- **既存コンポーネントの活用:** `jp.moyashi.phoneos.core.ui.components` で利用可能なUIコンポーネントを最大限活用してください。
- **テーマの遵守:** UI要素の色をハードコードせず、すべて `Theme.java` から取得してください。
- **パフォーマンスへの配慮:** スムーズなアニメーションとインタラクションを保証してください。特にタブを閉じた際やアプリがバックグラウンドになった際のメモリリークを防ぐため、ブラウザインスタンスのライフサイクルを適切に管理してください。

---

## 7. 機能実装ロードマップ

### 7.1. 優先機能
| 区分 | 機能 | 概要 | 実装メモ |
| :--- | :--- | :--- | :--- |
| コア | タブ管理 | カード型タブ一覧、ピン留め、プライベートモードを実装 | オーバーレイ型タブリストと新規/閉じる操作を暫定実装済み。`ChromiumBrowserManager` にタブモデルを追加し、次段ではサムネイル描画とピン留めを実装 |
| コア | ブックマーク・履歴 | VFS保存、検索・フォルダー分類、最新順ソート | 書き込みは遅延保存（一定時間ごと）でI/O負荷を抑制 |
| コア | httpm拡張 | POST、ファイルDL、エラー通知 | `HttpmSchemeHandler` 拡張。UIにはアドレスバー下部のバナー表示 |
| UX  | リーダーモード | ページ本文抽出、ナイトテーマ対応 | 明示的な切り替え操作時のみ抽出処理を行う |
| UX  | メディアコントロール | 音声/動画再生用の小型プレーヤー通知 | Forge/Standalone共通の`NotificationManager` と連携 |

### 7.2. 機能別UIフロー
- **タブ追加:** 下部バー中央の `[➕]` → 新タブ作成後、即座にアドレスバーへフォーカス。
- **タブ一覧:** 上部アドレスバー右端または下部バー `[□]` → 2列カードグリッド → タップで切替、スワイプで削除。
- ※暫定実装では全画面オーバーレイでタブカードを縦並び表示。タブをタップすると切替、背景タップでクローズ。サムネイル/削除操作は今後追加。
- **ブックマーク:** アドレスバー右の `✰` → 状態トグル → 下部トーストで完了通知。ブックマーク一覧はその他オプション経由。
- **履歴:** 「その他オプション」→ `[🕒] 履歴` → 時系列リスト（検索バー付き）。リストは遅延読み込み。
- **リーダーモード:** メニューまたはアドレスバーアイコンから切り替え。元のページスタイルへ戻れるトグルを提供。

---

## 8. 軽量化・パフォーマンス方針

### 8.1. レンダリング制御
- **フレームレート上限:** OSRブラウザはデフォルト30fps。非アクティブタブは `CefBrowser.setWindowlessFrameRate(5)` へ落とす。
- **無操作時スリープ:** `ChromiumBrowser.needsUpdate()` が `false` の間は `Kernel.render()` でブラウザ領域の再描画をスキップ。
- **Forge対応:** `ChromiumManager.doMessageLoopWork()` の呼び出し間隔をプレイヤー操作状況に応じて調整（例: 3フレームに1回）。

### 8.2. 入力イベント最適化
- **Standalone:** 公開API（`CefBrowserHost.send*Event`）への移行を進め、反射呼び出しを段階的に廃止。
- **Forge:** `MCEFBrowser` の `scaleX/scaleY` を活用し、送信イベントを正規化。ドラッグ/ズームなど継続入力は必要時のみ送信。

### 8.3. リソース管理
- **タブサムネイル:** 低解像度（最大200x120）でキャプチャし、VFSへPNG圧縮保存。キャッシュはLRUで管理。
- **ブックマーク/履歴:** 変更が蓄積した場合のみバッチ書き込みを行い、頻繁なI/Oを抑制する。
- **ネットワーク:** httpmプロトコル経由のダウンロードやフォーム送信も、Forge環境のTPSを阻害しないよう非同期処理＋進捗通知を採用。

### 8.4. UI負荷軽減
- アニメーションは `200ms` 以下の短いフェード/スライドのみに限定。
- 透過レイヤーやぼかし効果は使用しない。明瞭な単色背景と影のみで階層表現する。
- 低スペック環境向けオプションとして「軽量モード」を用意し、タブサムネイル無効化・読込アニメーション簡略化を提供。
